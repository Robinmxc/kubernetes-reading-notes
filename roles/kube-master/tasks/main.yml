- name: 修改kubelet对应的cgroupDriver
  shell: "grep --cgroup-driver=cgroupfs /usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf >> /dev/null; \
          if [ $? -ne 0 ]; \
          then sed -i \"s#--kubeconfig=/etc/kubernetes/kubelet.conf#--kubeconfig=/etc/kubernetes/kubelet.conf --cgroup-driver=cgroupfs#g\" /usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf; \
          fi;"
  tags: upgrade_k8s

- name: 加载kubernetes镜像包
  shell: 'path={{ base_dir }}/down/kubernetes-{{ KUBERNETES_VERSION }}; \
          files=$(ls $path); \
          cd $path;
          for filename in $files; \
          do docker load -i $filename; \
          done;'
  tags: upgrade_k8s

- name: 重置kubeadm
  shell: 'kubeadm reset -f'
  run_once: True
  tags: upgrade_k8s

- name: 通过kubeadm安装并启动kubernetes
  shell: 'kubeadm init --apiserver-advertise-address={{ groups.deploy[0] }} \
          --kubernetes-version={{ KUBERNETES_VERSION }} --image-repository registry.aliyuncs.com/google_containers \
          --pod-network-cidr=196.200.192.0/20; \
          mkdir -p $HOME/.kube; \
          sudo cp /etc/kubernetes/admin.conf $HOME/.kube/config; \
          sudo chown $(id -u):$(id -g) $HOME/.kube/config; \
          export KUBECONFIG=/etc/kubernetes/admin.conf'
  run_once: True
  tags: upgrade_k8s

- name: 以轮询的方式等待master服务启动完成
  command: "kubectl get node"
  register: result
  until:    result.rc == 0
  retries:  10
  delay: 10
  delegate_to: "{{ groups.deploy[0] }}"
  run_once: True
  tags: upgrade_k8s, restart_master

- name: 配置{{ BASIC_AUTH_USER }}用户rbac权限
  template: src=basic-auth-rbac.yaml.j2 dest=/opt/kube/basic-auth-rbac.yaml
  when: 'BASIC_AUTH_ENABLE == "yes"'
  delegate_to: "{{ groups.deploy[0] }}"
  run_once: true
  tags: restart_master

- name: 创建{{ BASIC_AUTH_USER }}用户rbac权限
  shell: "kubectl apply -f /opt/kube/basic-auth-rbac.yaml"
  when: 'BASIC_AUTH_ENABLE == "yes"'
  delegate_to: "{{ groups.deploy[0] }}"
  run_once: true
  tags: restart_master
- name: 安装unzip
  yum:
    name:
      - unzip
    state: present

- name: 读取目录状态
  stat: path="{{ KAD_PACKAGE_DIR }}"
  register: pkg_dir_stat

- name: 读取安装包状态
  stat: path="{{ base_dir }}/down/{{ KAD_PACKAGE_NAME }}.zip"
  register: pkg_stat
  when: 'not pkg_dir_stat.stat.exists'

- name: 下载安装包
  when: 'not pkg_dir_stat.stat.exists and not pkg_stat.stat.exists'
  get_url:
    url: "{{ KAD_FILES_REPO }}/sourceid/kad/{{ KAD_PACKAGE_NAME }}.zip"
    dest: "{{ base_dir }}/down/"

- name: 解压
  when: 'not pkg_dir_stat.stat.exists'
  block:
  - name: 创建解压目录
    file: path="{{ KAD_PACKAGE_DIR }}" state=directory
  - name: 解压SourceID安装包
    unarchive:
      src: "{{ base_dir }}/down/{{ KAD_PACKAGE_NAME }}.zip"
      dest: "{{ KAD_PACKAGE_DIR }}"

- name: 读取镜像包状态
  stat: path="{{ KAD_PACKAGE_DIR }}/images-download.ok"
  register: image_pkg_stat

- name: 下载镜像包
  when: 'not image_pkg_stat.stat.exists'
  block:
  - name: 下载镜像包
    get_url:
      url: "{{ KAD_FILES_REPO }}/sourceid/images/sourceid-images-{{ KAD_APP_VERSION }}.tar.gz"
      dest: "{{ base_dir }}/down/"
  - name: 读取压缩包状态
    stat: path="{{ base_dir }}/down/sourceid-images-{{ KAD_APP_VERSION }}.tar.gz"
    register: tgz_info
  - name: 设置下载标识
    file:
      path: "{{ KAD_PACKAGE_DIR }}/images-download.ok"
      state: touch
    when: 'tgz_info.stat.exists'
  - name: 解压安装包
    unarchive:
      src: "{{ base_dir }}/down/sourceid-images-{{ KAD_APP_VERSION }}.tar.gz"
      dest: "{{ base_dir }}/down/"
    when: 'tgz_info.stat.exists'
  - name: 删除压缩包
    file:
      path: "{{ base_dir }}/down/sourceid-images-{{ KAD_APP_VERSION }}.tar.gz"
      state: absent
    when: 'tgz_info.stat.exists'

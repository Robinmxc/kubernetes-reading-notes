- name: 安装unzip
  yum:
    name:
      - unzip
    state: present

- name: 读取安装包状态
  stat: path="{{ base_dir }}/down/sourceid-kad-{{ SOURCEID_KAD_VERSION }}.ok"
  register: setup_pkg_stat

- name: 下载安装包
  when: 'not setup_pkg_stat.stat.exists'
  block:
  - name: 下载安装包
    get_url:
      url: "{{ KAD_FILES_REPO }}/sourceid/kad/sourceid-kad-{{ SOURCEID_KAD_VERSION }}.zip"
      dest: "{{ base_dir }}/down/"
  - name: 读取压缩包状态
    stat: path="{{ base_dir }}/down/sourceid-kad-{{ SOURCEID_KAD_VERSION }}.zip"
    register: tgz_info
  - name: 设置下载标识
    file:
      path: "{{ base_dir }}/down/sourceid-kad-{{ SOURCEID_KAD_VERSION }}.ok"
      state: touch
    when: 'tgz_info.stat.exists'
  - name: 解压安装包
    unarchive:
      src: "{{ base_dir }}/down/sourceid-kad-{{ SOURCEID_KAD_VERSION }}.zip"
      dest: "{{ sourceid_kad_temp_dir }}"
    when: 'tgz_info.stat.exists'


- name: 读取镜像包状态
  stat: path="{{ base_dir }}/down/sourceid-images-{{ SOURCEID_KAD_VERSION }}.ok"
  register: image_pkg_stat

- name: 下载镜像包
  when: 'not image_pkg_stat.stat.exists'
  block:
  - name: 下载镜像包
    get_url:
      url: "{{ KAD_FILES_REPO }}/sourceid/images/sourceid-images-{{ SOURCEID_KAD_VERSION }}.tar.gz"
      dest: "{{ base_dir }}/down/"
  - name: 读取压缩包状态
    stat: path="{{ base_dir }}/down/sourceid-images-{{ SOURCEID_KAD_VERSION }}.tar.gz"
    register: tgz_info
  - name: 设置下载标识
    file:
      path: "{{ base_dir }}/down/sourceid-images-{{ SOURCEID_KAD_VERSION }}.ok"
      state: touch
    when: 'tgz_info.stat.exists'
  - name: 解压安装包
    unarchive:
      src: "{{ base_dir }}/down/sourceid-images-{{ SOURCEID_KAD_VERSION }}.tar.gz"
      dest: "{{ base_dir }}/down/"
    when: 'tgz_info.stat.exists'
  - name: 删除压缩包
    file:
      path: "{{ base_dir }}/down/sourceid-images-{{ SOURCEID_KAD_VERSION }}.tar.gz"
      state: absent
    when: 'tgz_info.stat.exists'

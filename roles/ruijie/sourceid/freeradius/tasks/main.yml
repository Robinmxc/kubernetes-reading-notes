- name: 部署freeradius
  when: 'FREERADIUS_ENABLE == "yes"'
  block:
  - name: 准备部署文件目录
    tags:
      - config
    file: path={{ item }} state=directory
    with_items:
      - "{{ yaml_dir }}/freeradius"
    run_once: true
    connection: local

  - name: 准备部署文件
    tags:
      - config
    vars:
      deploy_conf: '{{ freeradius_deploy_conf }}'
      comp_name: 'freeradius'
      deploy_node_ip: "{{ groups.ess[0] }}"
    template: src='freeradius.yaml.j2' dest={{ yaml_dir }}/freeradius/freeradius.yml
    run_once: true
    connection: local

  - name: 获取所有已经创建的POD信息
    tags:
      - deploy
    command: "kubectl get pod -n {{ APP_NAMESPACE }}"
    register: pod_info
    run_once: true
    connection: local

  - name: 检查部署状态
    tags:
      - deploy
    shell: "rm -rf {{ yaml_dir }}/diff.txt; \
        kubectl diff -f {{ yaml_dir }}/freeradius/freeradius.yml > {{ yaml_dir }}/diff.txt; \
        echo 'x' >> {{ yaml_dir }}/diff.txt;"
    ignore_errors: true
    run_once: true
    connection: local

  - name: 获取差别
    tags:
      - deploy
    shell: "cat {{ yaml_dir }}/diff.txt | head -n 1"
    register: diff_output
    run_once: true
    connection: local

  - name: 执行更新
    tags:
      - deploy
    when: '"x" != diff_output.stdout_lines[0]'
    block:
      - name: 停止 freeradius
        command: "kubectl delete -f {{ yaml_dir }}/freeradius/"
        when: 'pod_info.stdout is search("rg-freeradius-[a-z0-9]*-[a-z0-9]*\s")'
        run_once: true
        connection: local

      - name: 等待freeradius结束运行
        shell: "kubectl get pod -n {{ APP_NAMESPACE }}"
        register: pod_info2
        when: 'pod_info.stdout is search("rg-freeradius-[a-z0-9]*-[a-z0-9]*\s")'
        until: 'pod_info2.stdout is not search("rg-freeradius-[a-z0-9]*-[a-z0-9]*\s")'
        retries: 30
        delay: 3
        ignore_errors: true
        run_once: true
        connection: local

  - name: 执行部署
    tags:
      - deploy
    shell: "kubectl apply -f {{ yaml_dir }}/freeradius/"
    run_once: true
    connection: local

- name: 部署freeradius
  when: 'FREERADIUS_ENABLE == "yes"'
  block:
    - name: 准备部署文件目录
      tags:
        - config
      file: path={{ item }} state=directory
      with_items:
        - "{{ yaml_dir }}/freeradius"
      run_once: true
      connection: local

    - name: 准备部署文件
      tags:
        - config
      vars:
        deploy_conf: '{{ freeradius_deploy_conf }}'
        comp_name: 'freeradius'
      template: src='freeradius.yaml.j2' dest={{ yaml_dir }}/freeradius/freeradius.yml
      run_once: true
      connection: local

    - name: 获取所有已经创建的POD信息
      tags:
        - deploy
      command: "kubectl get pod -n {{ APP_NAMESPACE }}"
      register: pod_info
      run_once: true
      connection: local

    - name: 执行部署
      tags:
        - deploy
      shell: "kubectl apply -f {{ yaml_dir }}/freeradius/"
      when: '"rg-freeradius" not in pod_info.stdout'
      run_once: true
      connection: local


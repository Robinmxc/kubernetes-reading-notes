- name: 部署rg_authentication_validate
  when: 'RG_AUTHENTICATION_VALIDATE_ENABLE == "yes"'
  block:
  - name: 复制配置文件
    tags:
      - config
    copy:
      src: "{{ namespace_dir }}/conf/sourceid/auth-extend/conf/"
      dest: "{{ config_base_dir }}/sourceid/auth-extend/conf/"

  - name: 自动配置
    tags:
      - config
    vars:
      deploy_node_ip: "{{ groups.ess[0] }}"
      pgsql_node_ip: "{{ groups.pgsql[0] }}"
    replace: path="{{ config_base_dir }}/sourceid/auth-extend/conf/application-pro.properties" regexp="{{ item.regexp }}" replace="{{ item.replace }}"
    with_items:
      - {regexp: "spring.datasource.username=.*$", replace: "spring.datasource.username=postgres"}
      - {regexp: "spring.datasource.password=.*$", replace: "spring.datasource.password={{ PGSQL_ADMIN_PWD }}"}
      - {regexp: "kube-ruijie.svc", replace: "{{ APP_NAMESPACE }}.svc"}
      - {regexp: "sid.log.rest.url =.*$", replace: "sid.log.rest.url = http://{{ deploy_node_ip }}:30908/log/remote/log/save"}
      - {regexp: "sid.log.mq.ip =.*$", replace: "sid.log.mq.ip = {{ deploy_node_ip }}:9876"}
      - {regexp: "spring.datasource.url=jdbc:postgresql:.*/essdb.*$", replace: "spring.datasource.url=jdbc:postgresql://{{ pgsql_node_ip }}:5432/essdb"}
      - {regexp: "mongodb:.*/linkid-dev.*$", replace: "mongodb://{{ SOURCEID_LINKID_DB_USER }}:{{ SOURCEID_LINKID_DB_PWD }}@{{ deploy_node_ip }}:27017/linkid-dev?replicaSet=rs0"}
    no_log: true

  - name: 准备部署文件目录
    tags:
      - config
    file: path={{ item }} state=directory
    with_items:
      - "{{ yaml_dir }}/rg-authentication-validate"
    run_once: true
    connection: local

  - name: 准备部署文件
    tags:
      - config
    vars:
      deploy_conf: '{{rg_authentication_validate_deploy_conf}}'
      ess_deploy_conf: '{{rg_authentication_validate_deploy_ess_conf}}'      
      var_conf: '{{rg_authentication_validate_var_conf}}'
      comp_name: 'rg-authentication-validate'
      deploy_node_ip: "{{ groups.ess[0] }}"
      pgsql_node_ip: "{{ groups.pgsql[0] }}"
    template: src='rg-authentication-validate.yaml.j2' dest={{ yaml_dir }}/rg-authentication-validate/rg-authentication-validate.yml
    run_once: true
    connection: local

  - name: 获取所有已经创建的POD信息
    tags:
      - deploy
    command: "kubectl get pod -n {{ APP_NAMESPACE }}"
    register: pod_info
    run_once: true
    connection: local

  - name: 执行部署
    tags:
      - deploy
    shell: "kubectl apply -f {{ yaml_dir }}/rg-authentication-validate/"
    run_once: true
    connection: local


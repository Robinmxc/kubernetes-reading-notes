- name: 部署License
  when: 'sourceid_license_enabled == "yes"'
  block:
  - name: 复制配置文件
    tags:
      - config
    copy:
      src: "{{ workspace_dir }}/conf/sourceid/license/conf/"
      dest: "{{ config_base_dir }}/sourceid/license/conf/"

  - name: 自动配置
    tags:
      - config
    no_log: true
    replace: path="{{ workspace_dir }}/conf/sourceid/license/conf/application.yaml" regexp="{{ item.regexp }}" replace="{{ item.replace }}"
    with_items:
      - {regexp: "mongodb:.*/linkid-dev.*$", replace: "mongodb://{{ SOURCEID_LINKID_DB_USER }}:{{ SOURCEID_LINKID_DB_PWD }}@{{ mongodb_addr }}/linkid-dev?replicaSet=rs0"}
      - {regexp: "kube-ruijie.svc", replace: "{{ APP_NAMESPACE }}.svc"}

  - name: 自定义配置
    tags:
      - config
    no_log: true
    replace:
      path: '{{ workspace_dir }}/conf/sourceid/license/conf/application.yaml'
      regexp: '{% if item.regexp is defined %}{{item.regexp}}{% else %}{{ item.name }}\s*=.*${% endif %}'
      replace: '{% if item.regexp is defined %}{{item.value}}{% else %}{{ item.name }}={{item.value}}{% endif %}'
    with_items: '{{ license_configs }}'

  - name: 准备部署文件目录
    tags:
      - config
    run_once: true
    connection: local
    file: path={{ item }} state=directory
    with_items:
      - "{{ yaml_dir }}/license"

  - name: 准备部署文件
    tags:
      - config
    run_once: true
    connection: local
    vars:
      deploy_conf: '{{ license_deploy_conf }}'
    template: src='{{ license_templates_path }}license.yaml.j2' dest={{ yaml_dir }}/license/license.yml

  - name: 获取所有已经创建的POD信息
    tags:
      - deploy
    run_once: true
    connection: local
    command: "{{ bin_dir }}/kubectl get pod -n {{ APP_NAMESPACE }}"
    register: pod_info

  - name: 执行部署
    tags:
      - deploy
    run_once: true
    connection: local
    shell: "{{ bin_dir }}/kubectl apply -f {{ yaml_dir }}/license/"
    when: '"rg-license" not in pod_info.stdout'

- name: 准备镜像复制目录
  file: path={{ item }} state=directory
  with_items:
  - "{{ img_copy_dir }}"

- name: 获取已复制的镜像文件信息
  command: "ls {{ img_copy_dir}}"
  register: images_copy_info

- name: 复制镜像文件
  vars:
    comp_name: "{{ item }}"
    docker_version: "{{ SOURCEID_DOCKERS[comp_name].version }}"
    img_file_name: "{{ comp_name }}-{{ docker_version }}.tar"
  copy: src={{ img_download_dir }}/{{ img_file_name }} dest={{ img_copy_dir }}/{{ img_file_name }}
  when: '"" != docker_version and img_file_name not in images_copy_info.stdout'
  with_items: "{{ SOURCEID_DOCKERS.keys() }}"

- name: 获取docker已加载的镜像信息
  command: "docker images --format ''{{ '{{' }}.Repository{{ '}}' }}:{{ '{{' }}.Tag{{ '}}' }}''"
  register: imgages_info

- name: 加载镜像
  vars:
    comp_name: "{{ item }}"
    docker_version: "{{ SOURCEID_DOCKERS[comp_name].version }}"
    img_id_ver: "{{ PRIVATE_INSECURE_REGISTRY }}/{{ SOURCEID_DOCKERS[comp_name].name }}:{{ docker_version }}"
    img_file_name: "{{ comp_name }}-{{ docker_version }}.tar"
  command: 'docker load -i {{ img_copy_dir }}/{{ img_file_name }}'
  when: '"" != docker_version and img_id_ver not in imgages_info.stdout'
  with_items: "{{ SOURCEID_DOCKERS.keys() }}"

- name: 更换脚本域名
  block:
  - name: 设置文件权限
    vars:
      src_file: "{{ KAD_PACKAGE_DIR }}/db/sourceid/rg-upgrade-db/update_domain.sh"
    when: 'src_file is exists'
    shell: "chmod +777 {{ KAD_PACKAGE_DIR }}/db/sourceid/rg-upgrade-db/update_domain.sh"

  - name: 执行替换脚本
    vars:
      SSO_DOMAIN_URL: '{% if SOURCEID_DOMAIN_MODE == "single" %}{{ SOURCEID_SSO_URL }}/{{ CAS_SUFFIX }}{% else %}{{ SOURCEID_SSO_URL }}{% endif %}'
      GATE_DOMAIN_URL: '{% if SOURCEID_DOMAIN_MODE == "single" %}{{ SOURCEID_FRONTEND_URL }}/{{ SELF_SUFFIX }}{% else %}{{ SOURCEID_FRONTEND_URL }}{% endif %}'
      src_file: "{{ KAD_PACKAGE_DIR }}/db/sourceid/rg-upgrade-db/update_domain.sh"
    when: 'src_file is exists'
    shell: "{{ KAD_PACKAGE_DIR }}/db/sourceid/rg-upgrade-db/update_domain.sh {{ GATE_DOMAIN_URL }} {{ SSO_DOMAIN_URL }} {{ KAD_PACKAGE_DIR }}"
    connection: local
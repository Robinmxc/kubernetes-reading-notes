- name: 部署sso-proxy
  when: 'SSO_PROXY_ENABLE == "yes"'
  block:
  - name: 复制配置文件
    tags:
      - config
    copy:
      src: "{{ namespace_dir }}/conf/sourceid/sso-proxy/"
      dest: "{{ config_base_dir }}/sourceid/sso-proxy/"

  - name: 自动配置
    tags:
      - config
    replace: path="{{ config_base_dir }}/sourceid/sso-proxy/conf/application.properties" regexp="{{ item.regexp }}" replace="{{ item.replace }}"
    with_items:
      - {regexp: "mongodb:.*/ssoproxy.*$", replace: "mongodb://{{ SOURCEID_SSO_PROXY_DB_USER }}:{{ SOURCEID_SSO_PROXY_DB_PWD }}@{{ mongodb_addr }}/sso-proxy?replicaSet=rs0"}
      - {regexp: "kube-ruijie.svc", replace: "{{ APP_NAMESPACE }}.svc"}
    no_log: true

  - name: 自定义配置
    tags:
      - config
    replace:
      path: '{{ config_base_dir }}/sourceid/sso-proxy/conf/application.properties'
      regexp: '{% if item.regexp is defined %}{{item.regexp}}{% else %}{{ item.name }}\s*=.*${% endif %}'
      replace: '{% if item.regexp is defined %}{{item.value}}{% else %}{{ item.name }}={{item.value}}{% endif %}'
    with_items: '{{ sso_proxy_configs }}'

  - name: sso认证配置
    tags:
      - config
    vars:
      sso_path: '{% if SOURCEID_DOMAIN_MODE == "single" %}{{ SOURCEID_SSO_URL }}/{{ CAS_SUFFIX }}{% else %}{{ SOURCEID_SSO_URL }}{% endif %}'
    replace: path="{{ config_base_dir }}/sourceid/sso-proxy/conf/application.properties" regexp="{{ item.regexp }}" replace="{{ item.replace }}"
    with_items:
      - { regexp: "https://sso.ruishan.cc", replace: "{{ sso_path }}" }
    no_log: true

  - name: 单域名配置
    tags:
      - config
    replace: path="{{ config_base_dir }}/sourceid/sso-proxy/conf/application.properties" regexp="{{ item.regexp }}" replace="{{ item.replace }}"
    with_items:
      - { regexp: "rg-sso.{{ APP_NAMESPACE }}.svc", replace: "rg-sso.{{ APP_NAMESPACE }}.svc/{{ CAS_SUFFIX }}" }
    no_log: true
    when: 'SOURCEID_DOMAIN_MODE == "single"'

  - name: 准备部署文件目录
    tags:
      - config
    file: path={{ item }} state=directory
    with_items:
      - "{{ yaml_dir }}/sso-proxy"
    run_once: true
    connection: local

  - name: 删除原定制yaml文件
    file: path="{{ yaml_dir }}/sso-proxy/sso-proxy.yaml" state=absent
    run_once: true
    connection: local

  - name: 准备部署文件
    tags:
      - config
    vars:
      deploy_conf: '{{ sso_proxy_deploy_conf }}'
    template: src='{{ sso_proxy_templates_path }}sso-proxy.yaml.j2' dest={{ yaml_dir }}/sso-proxy/sso-proxy.yml
    run_once: true
    connection: local

  - name: 获取所有已经创建的POD信息
    tags:
      - deploy
    command: "kubectl get pod -n {{ APP_NAMESPACE }}"
    register: pod_info
    run_once: true
    connection: local

  - name: 执行部署
    tags:
      - deploy
    shell: "kubectl apply -f {{ yaml_dir }}/sso-proxy/"
    run_once: true
    connection: local

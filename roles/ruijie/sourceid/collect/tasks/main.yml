- name: 部署collect
  when: 'COLLECT_ENABLE == "yes"'
  block:
  - name: 复制配置文件
    tags:
      - config
    copy:
      src: "{{ namespace_dir }}/conf/sourceid/collect/conf/"
      dest: "{{ config_base_dir }}/sourceid/collect/conf/"

  - name: 查询采集任务初始化状态
    shell: '{{ mongo_shell }} --eval ''db.getSiblingDB("linkid-dev").getCollection("DICT_CONFIG").find({"_id":ObjectId("5d9ea792e0f39a75feea719f")})'''
    register: mongo_result
    failed_when: 'mongo_result.stdout is search(mongo_shell_fail_pattern) and mongo_result.stdout is not search(mongo_shell_success_pattern)'
    connection: local

  - name: 执行初始化脚本
    shell: '{{ mongo_pod_shell }} /ruijie/init/init-data.sh'
    when: '"5d9ea792e0f39a75feea719f" not in mongo_result.stdout'
    register: mongo_result
    failed_when: 'mongo_result.stdout is search(mongo_shell_fail_pattern) and mongo_result.stdout is not search(mongo_shell_success_pattern)'
    connection: local

  - name: 准备部署文件目录
    tags:
      - config
    file: path={{ item }} state=directory
    with_items:
    - "{{ yaml_dir }}/gate"
    run_once: true
    connection: local

  - name: 准备部署文件
    tags:
      - config
    vars:
      deploy_conf: '{{ collect_deploy_conf }}'
    template: src='{{ collect_templates_path }}collect.yaml.j2' dest={{ yaml_dir }}/collect/collect.yml
    run_once: true
    connection: local

  - name: 获取所有已经创建的POD信息
    tags:
      - deploy
    command: "{{ bin_dir }}/kubectl get pod -n {{ APP_NAMESPACE }}"
    register: pod_info
    run_once: true
    connection: local

  - name: 执行部署
    tags:
      - deploy
    shell: "{{ bin_dir }}/kubectl apply -f {{ yaml_dir }}/collect/"
    when: '"rg-gate" not in pod_info.stdout'
    run_once: true
    connection: local
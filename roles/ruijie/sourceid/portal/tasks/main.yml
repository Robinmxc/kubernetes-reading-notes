- name: 部署portal
  when: 'PORTAL_ENABLE == "yes"'
  block:
  - name: 复制配置文件
    tags:
      - config
    copy:
      src: "{{ namespace_dir }}/conf/sourceid/portal/conf/"
      dest: "{{ config_base_dir }}/sourceid/portal/conf/"

  - name: 自动配置
    tags:
      - config
    replace: path="{{ config_base_dir }}/sourceid/portal/conf/application.yml" regexp="{{ item.regexp }}" replace="{{ item.replace }}"
    with_items:
      - {regexp: "mongodb:.*/application.*$", replace: "mongodb://{{ SOURCEID_APPLICATION_FACADE_DB_USER }}:{{ SOURCEID_APPLICATION_FACADE_DB_PWD }}@{{ mongodb_addr }}/application-facade?replicaSet=rs0"}
      - {regexp: "url:.*$", replace: "url: {{ SOURCEID_SSO_URL }}"}
      - {regexp: "apiServer:.*$", replace: "apiServer: {{ SOURCEID_MYAPP_URL }}"}
      - {regexp: "name:.*$", replace: "name: {{ SOURCEID_MYAPP_URL }}"}
    no_log: true

  - name: 单域名配置
    tags:
      - config
    vars:
      cas_url: '{% if CAS_SUFFIX != "" %}{{ SOURCEID_SSO_URL }}/{{ CAS_SUFFIX }}{% else %}{{ SOURCEID_SSO_URL }}{% endif %}'
      portal_url: '{% if PORTAL_SUFFIX != "" %}{{ SOURCEID_SSO_URL }}/{{ PORTAL_SUFFIX }}{% else %}{{ SOURCEID_SSO_URL }}{% endif %}'
    replace: path="{{ config_base_dir }}/sourceid/portal/conf/application.yml" regexp="{{ item.regexp }}" replace="{{ item.replace }}"
    with_items:
      - {regexp: "url:.*$", replace: "url: {{ cas_url }}"}
      - {regexp: "apiServer:.*$", replace: "apiServer: {{ portal_url }}"}
      - {regexp: "name:.*$", replace: "name: {{ SOURCEID_SSO_URL }}"}
      - {regexp: "context-path:.*$", replace: "context-path: /{{PORTAL_SUFFIX }}"}
    no_log: true
    when: 'SOURCEID_DOMAIN_MODE == "single"'

  - name: 准备部署文件目录
    tags:
      - config
    file: path={{ item }} state=directory
    with_items:
    - "{{ yaml_dir }}/portal"
    run_once: true
    connection: local

  - name: 准备部署文件
    tags:
      - config
    vars:
      deploy_conf: '{{ portal_deploy_conf }}'
    template: src='{{ portal_templates_path }}portal.yaml.j2' dest={{ yaml_dir }}/portal/portal.yml
    run_once: true
    connection: local

  - name: 获取所有已经创建的POD信息
    tags:
      - deploy
    command: "kubectl get pod -n {{ APP_NAMESPACE }}"
    register: pod_info
    run_once: true
    connection: local

  - name: 执行部署
    tags:
      - deploy
    shell: "kubectl apply -f {{ yaml_dir }}/portal/"
    run_once: true
    connection: local
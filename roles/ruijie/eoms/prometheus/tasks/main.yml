- name: 集群内部署Prometheus监控
  when: 'PROMETHEUS_ENABLE == "yes"'
  block:
  - name: 准备目录
    file: name={{ item }} state=directory
    with_items:
    - "{{ prometheus_default_dir }}"

  - name: 复制文件
    vars:
      file_name: "{{ item }}"
    copy: 
      src: "{{ EOMS_DOWN_PATH }}/{{ file_name }}"
      dest: "{{ prometheus_default_dir }}/{{ file_name }}"
    with_items: 
    - "{{ prometheus_yml_file }}"

  - name: 解压 prometheus 文件
    shell: "tar -zxvf {{ prometheus_default_dir }}/{{ prometheus_yml_file }} -C {{ prometheus_default_dir }} >/dev/null"
    no_log: true

  - name: 自动配置
    tags:
      - config
    replace: path="{{ prometheus_default_dir }}/prometheus/manifests/prometheus-prometheus.yaml" regexp="{{ item.regexp }}" replace="{{ item.replace }}"
    with_items:
      - {regexp: "url:.*$", replace: "url: \"https://{{ groups.influxdb[0] }}:8086/api/v1/prom/write?db=prometheus\""}
    no_log: true
  
  - name: 获取所有已经创建的POD信息
    tags:
      - deploy
    command: "kubectl get pod -n monitoring"
    register: pod_info
    run_once: true
    connection: local

  - name: 启动 prometheus 配置
    shell: "kubectl create -f {{ prometheus_default_dir }}/prometheus/manifests/setup/"
    when: '"prometheus" not in pod_info.stdout'
    run_once: true

  - name: 创建 prometheus secret
    shell: "kubectl create secret generic additional-configs --from-file={{ prometheus_default_dir }}/prometheus/prometheus-additional.yaml -n monitoring"
    when: '"prometheus" not in pod_info.stdout'
    run_once: true

  - name: 启动 prometheus 
    shell: "kubectl create -f {{ prometheus_default_dir }}/prometheus/manifests/"
    when: '"prometheus" not in pod_info.stdout'
    run_once: true

  - name: 准备controller监控文件
    tags:
      - config
    vars:
      file_name: "{{ item }}"
    template: src='{{ file_name }}.j2' dest={{ prometheus_default_dir }}/prometheus/k8score-metrics/{{ file_name }}
    with_items:
    - "controller-manager-prometheus-svc.yaml"
    - "etcd-prometheus-svc.yaml"
    - "proxy-prometheus-svc.yaml"
    - "scheduler-prometheus-svc.yaml"
    run_once: true

  - name: 启动服务监控 
    shell: "kubectl create -f {{ prometheus_default_dir }}/prometheus/k8score-metrics/"
    when: '"prometheus" not in pod_info.stdout'
    run_once: true

  - name: 启动prometheus pushgateway
    shell: "kubectl create -f {{ prometheus_default_dir }}/prometheus/pushgateway/"
    when: '"prometheus" not in pod_info.stdout'
    run_once: true


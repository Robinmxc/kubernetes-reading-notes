- name: 准备目录
  file: name={{ item }} state=directory
  with_items:
  - "{{ prometheus_default_dir }}/prometheus/pushgateway/script/"

- name: 准备时间监控脚本
  tags:
    - config
  vars:
    file_name: "{{ item }}"
    nodeip: "hostvars[inventory_hostname]['ansible_default_ipv4']['address']"
  template: 
    src: "{{ file_name }}.j2" 
    dest: "{{ prometheus_default_dir }}/prometheus/pushgateway/script/{{ file_name }}"
  with_items:
  - "system_date.sh"

- name: 准备自定义监控脚本
  tags:
    - config
  vars:
    file_name: "{{ item }}"
    nodeip: "hostvars[inventory_hostname]['ansible_default_ipv4']['address']"
  template: 
    src: "{{ file_name }}.j2"
    dest: "{{ prometheus_default_dir }}/prometheus/pushgateway/script/{{ file_name }}"
  with_items:
  - "componentVersion.sh"
  - "kubectlCmd.sh"

- name: 设置文件执行权限
  tags:
    - config
  file: name="{{ prometheus_default_dir }}/prometheus/pushgateway/script/{{ item }}" mode=0777
  with_items:
  - "componentVersion.sh"
  - "kubectlCmd.sh"
  - "system_date.sh"

- name: 准备文件
  file: name={{ item }} state=touch
  with_items:
  - "/var/spool/cron/root"

- name: 配置自动执行
  tags:
    - config
  shell: "sed -i '/{{ item }}/d' /var/spool/cron/root && echo '*/1 * * * * sh {{ prometheus_default_dir }}/prometheus/pushgateway/script/{{ item }}' >> /var/spool/cron/root"
  with_items:
  - "system_date.sh"

- name: 配置自动执行
  tags:
    - config
  shell: "sed -i '/{{ item }}/d' /var/spool/cron/root && echo '*/1 * * * * sh {{ prometheus_default_dir }}/prometheus/pushgateway/script/{{ item }}' >> /var/spool/cron/root"
  with_items:
  - "kubectlCmd.sh"
  run_once: true
  connection: local

- name: 配置自动执行
  tags:
    - config
  shell: "sed -i '/{{ item }}/d' /var/spool/cron/root && echo '*/5 * * * * sh {{ prometheus_default_dir }}/prometheus/pushgateway/script/{{ item }}' >> /var/spool/cron/root"
  with_items:
  - "componentVersion.sh"
  run_once: true
  connection: local
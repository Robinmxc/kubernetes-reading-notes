- name: 检查restic是否安装
  shell: yum list installed | grep "restic" /dev/null 2>&1
  register: has_restic
  failed_when: false
  no_log: true

- name: 安装restic
  shell: |
    yum -y install yum-plugin-copr
    yum -y copr enable copart/restic
    yum -y install restic
  when: has_restic.rc != 0

- name: 检查expect是否安装
  shell: yum list installed | grep "expect" /dev/null 2>&1
  register: has_expect
  failed_when: false
  no_log: true

- name: 安装expect
  shell: yum -y install expect
  when: has_expect.rc != 0

- name: 准备目录
  file: name={{working_dir}} state=directory

- name: 设置fdfs_backup参数
  template: src=fdfs_backup.sh.j2 dest={{working_dir}}/fdfs_backup.sh

- name: 设置set_cron参数
  template: src=set_cron.sh.j2 dest={{working_dir}}/set_cron.sh

- name: 设置set_ssh_nonlogin参数
  template: src=set_ssh_nonlogin.sh.j2 dest={{working_dir}}/set_ssh_nonlogin.sh

- name: 生成ssh密钥
  shell: ssh-keygen -q -t rsa -N '' <<< ""$'\n'"y" 2>&1 >/dev/null
  ignore_errors: true

- name: 设置ssh免登录
  shell: expect {{working_dir}}/set_ssh_nonlogin.sh
  ignore_errors: true

- name: 设置定时备份任务
  shell: sh {{working_dir}}/set_cron.sh


#!/bin/bash
export RESTIC_PASSWORD={{FAST_DFS.RESTIC_PASSWORD}}

echo -----------------------starting remote backup-----------------------------

REMOTE_BACKUP_PATH="sftp://{{FAST_DFS.BACKUP_USER}}@{{FAST_DFS.BACKUP_SERVER_IP}}:/{{FAST_DFS.REMOTE_BACKUP_PATH}}"

echo remote url is: ${REMOTE_BACKUP_PATH}

restic snapshots -r ${REMOTE_BACKUP_PATH}
if [ $? -eq 0 ]; then
    echo remote reposiroty already inited, removing remote reversions three days ago
    restic -r ${REMOTE_BACKUP_PATH} forget --keep-last 2 --prune
else
    echo init remote reposiroty...
    restic init -r ${REMOTE_BACKUP_PATH}
fi

echo starting backup to remote reposiroty...
restic backup -r ${REMOTE_BACKUP_PATH} --verbose {{FAST_DFS.FDFS_IMG_DATA_PATH}}

echo -----------------------remote backup complete----------------------------

if [ "false" == "true" ];then

    echo -----------------------starting local backup-----------------------------

    echo local url is: {{FAST_DFS.LOCAL_BACKUP_PATH}}

    restic snapshots -r {{FAST_DFS.LOCAL_BACKUP_PATH}}
    if [ $? -eq 0 ]; then
        echo local reposiroty already inited, removing local reversions three days ago
        restic -r {{FAST_DFS.LOCAL_BACKUP_PATH}} forget --keep-last 2 --prune
    else
        echo init local reposiroty...
        restic init -r {{FAST_DFS.LOCAL_BACKUP_PATH}}
    fi

    echo starting backup to local reposiroty...
    restic backup -r {{FAST_DFS.LOCAL_BACKUP_PATH}} --verbose {{FAST_DFS.FDFS_IMG_DATA_PATH}}

    echo -----------------------local backup complete------------------------------

fi
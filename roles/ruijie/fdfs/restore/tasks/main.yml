- name: 检查restic是否安装
  shell: yum list installed | grep "restic" /dev/null 2>&1
  register: has_restic
  failed_when: false
  no_log: true

- name: 安装restic
  shell: |
    yum -y install yum-plugin-copr
    yum -y copr enable copart/restic
    yum -y install restic
  when: has_restic.rc != 0

- name: 检查expect是否安装
  shell: yum list installed | grep "expect" /dev/null 2>&1
  register: has_expect
  failed_when: false
  no_log: true

- name: 安装expect
  shell: yum -y install expect
  when: has_expect.rc != 0

- name: 准备目录
  file: name={{working_dir}} state=directory

- name: 设置set_ssh_nonlogin参数
  template: src=set_ssh_nonlogin.sh.j2 dest={{working_dir}}/set_ssh_nonlogin.sh

- name: 设置ssh免登录
  shell: expect {{working_dir}}/set_ssh_nonlogin.sh
  ignore_errors: true
  failed_when: false
  no_log: true

- name: 正在恢复，花费时间可能较长，请耐心等待。。。
  template: src=restore.sh.j2 dest={{working_dir}}/restore.sh

- name: 等待恢复结果。。。
  shell: sh {{working_dir}}/restore.sh
  ignore_errors: true
  register: restore_result
  failed_when: restore_result.rc != 0

- name: 恢复成功
  debug:
    msg: "{{ restore_result.stdout.split('\n') }}"
  when: restore_result.rc == 0
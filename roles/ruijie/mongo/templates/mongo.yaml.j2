apiVersion: v1
kind: Service
metadata:
  name: {{ mongodb_node_name }}
  namespace: {{ APP_NAMESPACE }}
spec:
  selector:
    service: {{ mongodb_node_name }}
  ports:
  - port: {{ mongodb_port }}
    targetPort: 27017
  clusterIP: None

---
apiVersion: v1
kind: Pod
metadata:
  namespace: {{ APP_NAMESPACE }}
  name: {{ mongodb_node_name }}
  labels:
    service: {{ mongodb_node_name }}
spec:
  nodeName: {{ mongodb_node_ip }}
  hostNetwork: true
  hostAliases:
{% for host in groups['mongodb'] %}
  - ip: "{{ host }}"
    hostnames:
    - "mongo{{ mongodb_node_name }}"
{% endfor %}
  containers:
  - name: mongo
    image: mongo:{{ mongodb_version }}
    imagePullPolicy: IfNotPresent
    command:
      - mongod
      - '--bind_ip_all'
      - '--replSet'
      - 'rs0'
      - '--smallfiles'
      - '--noprealloc'
      - '--enableMajorityReadConcern'
      - 'false'
      - '--wiredTigerCacheSizeGB'
      - '{{ wiredTigerCacheSizeGB }}'
{% if mongodb_auth_mode == 'yes' %}
      - '--clusterAuthMode'
      - 'keyFile'
      - '--keyFile'
      - '/conf/keyfile'
      - '--auth'
{% endif %}
{% if "dict" == (deploy_conf.resources | type_debug) %}
    resources:
      limits:
        cpu: {{ deploy_conf.resources.limits.cpu }}
        memory: {{ deploy_conf.resources.limits.memory }}
      requests:
        cpu: {{ deploy_conf.resources.requests.cpu }}
        memory: {{ deploy_conf.resources.requests.memory }}
{% endif %}
    ports:
      - containerPort: 27017
        hostPort: 27017
    volumeMounts:
      - mountPath: /data/db
        name: data
{% if mongodb_auth_mode == 'yes' %}
      - mountPath: /conf/keyfile
        name: keyfile
        subPath: keyfile
{% endif %}
{% if mongodb_init_dir != '' %}
      - mountPath: /ruijie/init
        name: init-dir
{% endif %}
{% if mongodb_liveness_probe == 'yes' %}
      - mountPath: /ruijie/bin/liveness-probe.sh
        name: mongodb-conf
        subPath: liveness-probe.sh
{% endif %}
{% if mongodb_liveness_probe == 'yes' %}
    livenessProbe:
      exec:
        command:
        - '/ruijie/bin/liveness-probe.sh'
      initialDelaySeconds: 60
      periodSeconds: 10
      timeoutSeconds: 1
      failureThreshold: 3
{% endif %}
  volumes:
  - name: data
    hostPath:
      path: {{ mongodb_data_dir }}
{% if mongodb_auth_mode == 'yes' %}
  - name: keyfile
    secret:
      secretName: mongo-key
      defaultMode: 0400
{% endif %}
{% if mongodb_init_dir != '' %}
  - name: init-dir
    hostPath:
      path: {{ mongodb_init_dir }}
{% endif %}
{% if mongodb_liveness_probe == 'yes' %}
  - name: mongodb-conf
    configMap:
      name: mongodb-conf
      items:
      - key: {{ liveness_probe_sh_config_key }}
        path: liveness-probe.sh
        mode: 0550
{% endif %}


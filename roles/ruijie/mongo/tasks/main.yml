- name: 获取数据存储路径状态
  stat: path="{{ mongodb_data_dir }}"
  register: data_dir_stat
  when: 'mongodb_check_data_dir == "yes"'

- name: 检查数据存储路径是否存在
  fail: msg="数据存储目录{{ mongodb_data_dir }}不存在"
  when: 'mongodb_check_data_dir == "yes" and not data_dir_stat.stat.exists
     and ( mongodb_deploy_mode == 3 or inventory_hostname == groups.mongodb[0] )'

- name: 准备init目录
  file: path="{{ mongodb_init_dir }}" state=directory
  when: '"" != mongodb_init_dir'

- name: 在deploy节点准备目录
  file: path={{ item }} state=directory
  with_items:
  - "{{ yaml_dir }}/mongo"
  run_once: true
  connection: local

- name: 获取已下载离线镜像信息
  command: "ls {{ base_dir }}/down"
  register: download_info
  connection: local
  run_once: true

- name: 获取所有已经创建的POD信息
  command: "{{ bin_dir }}/kubectl get pod -n {{ namespace }}"
  register: pod_info
  run_once: true
  connection: local

- block:
    - name: 尝试推送离线mongodb镜像（若执行失败，可忽略）
      copy: src={{ base_dir }}/down/{{ mongodb_offline }} dest=/opt/kube/images/{{ mongodb_offline }}
      when: 'mongodb_offline in download_info.stdout'

    - name: 获取mongodb离线镜像推送情况
      command: "ls /opt/kube/images"
      register: image_info

    - name: 导入mongodb的离线镜像（若执行失败，可忽略）
      shell: "{{ bin_dir }}/docker load -i /opt/kube/images/{{ mongodb_offline }}"
      when: 'mongodb_offline in image_info.stdout'

    - name: 准备第1个mongodb的部署文件
      vars:
        mongodb_node_name: "mongo1"
        mongodb_node_ip: "{{ groups.mongodb[0] }}"
      template: src=mongdb.yaml.j2 dest={{ yaml_dir }}/mongo/mongo1.yml
      run_once: true
      connection: local

    - name: 部署第1个mongodb
      shell: "{{ bin_dir }}/kubectl apply -f {{ yaml_dir }}/mongo/mongo1.yml"
      connection: local
      run_once: true

    - name: 准备第2个mongodb的部署文件
      vars:
        mongodb_node_name: "mongo2"
        mongodb_node_ip: "{{ groups.mongodb[1] }}"
      template: src=mongdb.yaml.j2 dest={{ yaml_dir }}/mongo/mongo2.yml
      run_once: true
      connection: local
      when: "mongodb_deploy_mode == 3"

    - name: 部署第2个mongodb
      shell: "{{ bin_dir }}/kubectl apply -f {{ yaml_dir }}/mongo/mongo2.yml"
      connection: local
      run_once: true
      when: "mongodb_deploy_mode == 3"

    - name: 准备第3个mongodb的部署文件
      vars:
        mongodb_node_name: "mongo3"
        mongodb_node_ip: "{{ groups.mongodb[2] }}"
      template: src=mongdb.yaml.j2 dest={{ yaml_dir }}/mongo/mongo3.yml
      run_once: true
      connection: local
      when: "mongodb_deploy_mode == 3"

    - name: 部署第3个mongodb
      shell: "{{ bin_dir }}/kubectl apply -f {{ yaml_dir }}/mongo/mongo3.yml"
      connection: local
      run_once: true
      when: "mongodb_deploy_mode == 3"

  when: '"mongo" not in pod_info.stdout'

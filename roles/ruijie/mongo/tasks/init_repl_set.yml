- block:
  - name: 获取mongo1 POD 名称
    shell: "{{ bin_dir }}/kubectl get pod -n {{ APP_NAMESPACE }} -o custom-columns=NAME:.metadata.name | grep mongo1"
    register: pod_name
    connection: local

  - name: set pod_shell
    set_fact:
      pod_shell: "{{ bin_dir }}/kubectl exec -n {{ APP_NAMESPACE }} {{ pod_name.stdout }} -- "
    connection: local

  - name: 查询复制集状态
    shell: "{{ pod_shell }} mongo --eval 'rs.status()'"
    register: rs_status
    connection: local

  - name: 准备初始化文件
    template: src="init-repl-set.js.j2" dest="{{ mongodb_init_dir }}/init-repl-set.js"
    when: 'inventory_hostname == groups.mongodb[0]'

  - name: 初始化复制集
    shell: "{{ pod_shell }} mongo /data/init/init-repl-set.js"
    when: '"PRIMARY" not in rs_status.stdout'
    connection: local

  - name: 暂停20秒等待复制集初始化完成
    wait_for: timeout=20
    delegate_to: localhost

  - name: 检测复制集完成状态
    shell: "{{ pod_shell }} mongo --eval 'rs.status()'"
    connection: local
    register: rs_status
    until: '"PRIMARY" in rs_status.stdout'
    retries: 3
    delay: 10

  when: 'mongodb_deploy_mode == 3 and inventory_hostname == groups.mongodb[0]'

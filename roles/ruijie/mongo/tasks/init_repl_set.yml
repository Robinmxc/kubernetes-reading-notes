- name: 准备初始化文件
  template: src="init-repl-set.js.j2" dest="{{ mongodb_init_dir }}/init-repl-set.js"
  when: 'mongodb_deploy_mode == "3" and inventory_hostname == groups.mongodb[0]'

- name: 准备单机初始化文件
  template: src="init-repl-set-single.js.j2" dest="{{ mongodb_init_dir }}/init-repl-set.js"
  when: 'mongodb_deploy_mode == "1" and inventory_hostname == groups.mongodb[0]'

- name: init
  connection: local
  run_once: true
  block:
  - name: set vars
    set_fact:
      mongo_shell_init_rs: "{{ mongo_pod_shell }} mongo {% if init_flag == '1' %}{{ mongo_auth_param }}{% endif %}"

  - name: 查询复制集状态
    shell: "{{ mongo_shell_init_rs }} --quiet --eval 'r1=rs.status(); r2=(r1.ok==0 && r1.code==94) ? 0 : 1;'"
    register: rs_status

  - name: 展示复制集状态查询结果
    debug:
      msg: " {{ rs_status }} "

    # 修改ip时的使用，解决查询复制集状态失败影响修改ip功能,不影响正常功能
  - name: 修改ip阶段再次查询复制集状态
    shell: "{{ mongo_shell_init_rs }} --quiet --eval 'r1=rs.status(); r2=(r1.ok==0 && r1.code==94) ? 0 : 1;'"
    register: changeIp_rs_status
    when: '"0" == rs_status.stdout and KAD_APP_NAME == "smpplus" and ischangeip is defined'
    until: '"0" != changeIp_rs_status.stdout'
    ignore_errors: true
    retries: 5
    delay: 5

  - name: 再次查询复制集状态
    shell: "{{ mongo_shell_init_rs }} --quiet --eval 'r1=rs.status(); r2=(r1.ok==0 && r1.code==94) ? 0 : 1;'"
    register: rs_status


  - name: 初始化复制集
    shell: "{{ mongo_shell_init_rs }} /ruijie/init/init-repl-set.js"
    when: '"0" == rs_status.stdout'

  # 修改ip时的使用,不影响正常功能
  - name: 准备修改ip初始化文件
    template: src="smpplus-update-repl-changeip.js.j2" dest="{{ mongodb_init_dir }}/smpplus-update-repl-changeip.js"
    when: 'inventory_hostname == groups.mongodb[0] and KAD_APP_NAME == "smpplus" and ischangeip is defined'

  # 修改ip时的使用,不影响正常功能
  - name: 修改复制集ip
    shell: "{{ mongo_shell_init_rs }} /ruijie/init/smpplus-update-repl-changeip.js"
    when: 'inventory_hostname == groups.mongodb[0] and KAD_APP_NAME == "smpplus" and ischangeip is defined'

  - name: 暂停20秒等待复制集初始化完成
    wait_for: timeout=20

  - name: 检测复制集完成状态
    shell: "{{ mongo_shell_init_rs }} --eval 'rs.status()'"
    register: rs_status
    until: '"PRIMARY" in rs_status.stdout'
    retries: 3
    delay: 10



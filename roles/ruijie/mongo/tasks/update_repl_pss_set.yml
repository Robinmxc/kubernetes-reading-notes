- name: 准备初始化文件
  template: src="init-repl-set.js.j2" dest="{{ mongodb_init_dir }}/init-repl-set.js"
  when: 'mongodb_deploy_mode == "3" and inventory_hostname == groups.mongodb[0] and mongdb_cluster_mode == "pss"'

- name: 准备复制集修复脚本
  template: src="init-repl-set-update-pss.js.j2" dest="{{ mongodb_init_dir }}/init-repl-set-update.js"
  when: 'mongodb_deploy_mode == "3" and inventory_hostname == groups.mongodb[0] and mongdb_cluster_mode == "pss"'

- name: init
  block:

  - name: 获取mongo1 POD 名称
    shell: "kubectl get pod -n {{ APP_NAMESPACE }} -o custom-columns=NAME:.metadata.name | grep mongo1"
    register: shell_result
    run_once: true
    connection: local
  - name: set vars mongo_pod_shell
    set_fact:
      mongo_pod_name: "{{ shell_result.stdout }}"
      mongo_pod_shell: "kubectl exec -n {{ APP_NAMESPACE }} {{ shell_result.stdout }} -- "
    run_once: true
    connection: local
  - name: set vars mongo_shell_init_rs
    set_fact:
      mongo_shell_init_rs: "{{ mongo_pod_shell }} mongo {{ mongo_auth_param }}"
    connection: local
    run_once: true

  - name: 查询复制集是否PSS状态
    shell: "{{ mongo_shell_init_rs }} --quiet --eval 'r1=rs.status().members[2].stateStr;'"
    register: rs_mongo3_status
    connection: local
    run_once: true

  - name: 输出复制集状态
    debug:
      msg: "{{rs_mongo3_status}}"
    connection: local
    run_once: true

  - name: 查看mongo3是否手工迁移
    shell: "cat /tmp/mongo/status | echo 'no' "
    register: status_pss
    connection: local
    run_once: true

  - name: 停止 mongodb3
    command: "kubectl delete -f {{ yaml_dir }}/mongo/mongo3.yml"
    run_once: true
    when: 'mongodb_deploy_mode == "3"  and mongdb_cluster_mode == "pss" and "ARBITER" == rs_mongo3_status.stdout'
    connection: local

  - name: 等待mongodb3结束运行
    wait_for: timeout=10
    when: 'mongodb_deploy_mode == "3"  and mongdb_cluster_mode == "pss" and "ARBITER" == rs_mongo3_status.stdout'
    connection: local
    run_once: true

  - name: 清理mongo3文件
    shell: "{% if ansible_host == groups.mongodb[2] %}rm -rf {{ mongodb_data_dir }}/*;{% else %}echo '无需执行';{%endif%}"
    when: ' mongodb_deploy_mode == "3"  and mongdb_cluster_mode == "pss" and "ARBITER" == rs_mongo3_status.stdout and "scp" not in status_pss.stdout'

  - name: 复制集模式PSA改变为PSS，进行复制集修复
    shell: "{{ mongo_shell_init_rs }} /ruijie/init/init-repl-set-update.js"
    when: 'mongodb_deploy_mode == "3"  and mongdb_cluster_mode == "pss" and "ARBITER" == rs_mongo3_status.stdout'
    connection: local
    run_once: true

  - name: 重启启动mongodb3
    command: "kubectl create -f {{ yaml_dir }}/mongo/mongo3.yml"
    run_once: true
    when: 'mongodb_deploy_mode == "3"  and mongdb_cluster_mode == "pss" and "ARBITER" == rs_mongo3_status.stdout'
    connection: local

  - name: 检测复制集完成状态
    shell: "{{ mongo_shell_init_rs }} --eval 'rs.status()'"
    register: rs_status
    until: '"PRIMARY" in rs_status.stdout'
    retries: 3
    delay: 10
    when: 'mongodb_deploy_mode == "3"  and mongdb_cluster_mode == "pss" and "ARBITER" == rs_mongo3_status.stdout'    
    connection: local
    run_once: true

  - name: 暂停20秒等待复制集初始化完成
    wait_for: timeout=20
    when: 'mongodb_deploy_mode == "3"  and mongdb_cluster_mode == "pss" and "ARBITER" == rs_mongo3_status.stdout'
    connection: local
    run_once: true

  - name: 清理手工迁移文件
    shell: "rm -rf /tmp/mongo/status;"
    when: 'mongodb_deploy_mode == "3"  and mongdb_cluster_mode == "pss" and "ARBITER" == rs_mongo3_status.stdout'    
    connection: local    
    run_once: true    
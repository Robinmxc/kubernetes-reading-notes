- name: 获取docker安装状态
  stat: 
    path: /etc/systemd/system/kadapi.service
  register: stat_result

- name: 安装kadapi
  when: "not stat_result.stat.exists"
  block:
    - name: 准备kadapi相关目录
      file: name={{ item }} state=directory
      with_items:
      - /etc/kad/api
    
    - name: 下载kadapi二进制文件
      copy: src={{ KADAPI_DOWN_PATH }}/{{ item }} dest=/etc/kad/api/{{ item }} mode=0755
      with_items:
      - kadapi
      - changeip.sh

    - name: 获取网卡配置文件名
      shell: 'grep -rnl "{{ inventory_hostname }}" ifcfg-*'
      args:
        chdir: "/etc/sysconfig/network-scripts"
      register: find_ifcfg

    - name: 准备创建证书所需文件
      copy: src={{ item }} dest=/etc/kad/ssl/{{ item }}
      with_items:
      - ca-config.json
      - ca-csr.json
      - kadapi-csr.json

    - name: 准备配置文件
      tags:
      - config
      vars:
        ifcfg: '{{ find_ifcfg.stdout }}'
      template: src='kadapi.yaml.j2' dest=/etc/kad/api/kadapi.yaml

    - name: 创建kadapi公钥
      shell: "cd /etc/kadapi/ssl && {{ bin_dir }}/cfssl gencert -initca ca-csr.json | {{ bin_dir }}/cfssljson -bare ca" 

    - name: 创建 kadapi证书和私钥
      shell: "cd /etc/kadapi/ssl && {{ bin_dir }}/cfssl gencert \
            -ca={{ ca_dir }}/ca.pem \
            -ca-key={{ ca_dir }}/ca-key.pem \
            -config={{ ca_dir }}/ca-config.json \
            -profile=kadapi kadapi-csr.json | {{ bin_dir }}/cfssljson -bare etcd"

    - name: 转换kadapi证书格式
      shell: "cd /etc/kadapi/ssl && openssl pkcs8 -topk8 -inform PEM -in /etc/kadapi/ssl/kadapi-key.pem -outform PEM -nocrypt > /etc/kadapi/ssl/kadapi-smp-key.pem"

    - name: 获取configmap数据
      command: "{{ bin_dir }}/kubectl -n {{ APP_NAMESPACE }} get configmap"
      register: kadapi_config
      connection: local
      run_once: true

    - name: 删除 kadapi 模板文件的 configmap
      command: "{{ bin_dir }}/kubectl -n {{ APP_NAMESPACE }} delete configmap kadapi-cert"
      when: '"kadapi-cert" in kadapi_config.stdout'
      connection: local
      run_once: true

    - name: 创建 kadapi 模板文件的 configmap
      shell: "{{ bin_dir }}/kubectl -n kube-system create configmap kadapi-cert --from-file=/etc/kadapi/ssl/"
      connection: local
      run_once: true

    - name: 创建kadapi的systemd unit文件
      copy: src=kadapi.service dest=/etc/systemd/system/kadapi.service

    - name: 开机启用kadapi服务
      shell: systemctl enable kadapi
      ignore_errors: true

    - name: 开启kadapi服务
      shell: systemctl daemon-reload && systemctl restart kadapi
      ignore_errors: true


    - name: 以轮询的方式等待服务同步完成
      shell: "systemctl status kadapi.service|grep Active"
      register: kadapi_status
      until: '"running" in kadapi_status.stdout'
      retries: 8
      delay: 8

- name: 准备基础目录
  file: path={{ item }} state=directory
  connection: local
  with_items:
    - "{{base_dir}}"

- name: 准备下载目录
  file: path={{ item }} state=directory
  with_items:
    - "{{base_dir}}/down"
    - "{{base_dir}}/down/rpms"

- name: 准备临时文件目录
  file: path={{ item }} state=directory
  with_items:
    - "{{ temp_dir }}"

- name: 读取目录状态
  stat: path="{{base_dir}}/bin/kubectl"
  register: pkg_dir_stat
  connection: local

- name: 离线包软件安装脚本拷贝
  copy: src={{ base_dir }}/rpminstall.sh dest={{ base_dir }}/down/rpms/
  with_items:
  - rpminstall.sh

- name: 设置离线包文件执行权限
  tags:
    - config
  file: name="{{ base_dir }}/down/rpms/{{ item }}" mode=0777
  with_items:
  - "rpminstall.sh"
#  run_once: true

- name: 查询系统信息
  shell: "uname -r"
  register: uname

- name: 准备系统依赖软件tar安装目录
  file: path="{{ base_dir }}/down/rpms/{{ uname.stdout }}" state=directory   
  when: '"allinone" != DEPLOY_MODE '

- name: 系统依赖软件tar拷贝
  when: '"allinone" != DEPLOY_MODE '
  ignore_errors: true
  block:  
  - name: 复制rpm包
    copy: 
      src: "{{ base_dir }}/down/rpms/{{ uname.stdout }}/tar" 
      dest: "{{ base_dir }}/down/rpms/{{ uname.stdout }}"

- name: 系统依赖软件tar安装
  shell: "rpm -ivh {{ base_dir }}/down/rpms/{{ uname.stdout }}/tar/*.rpm --force --nodeps"
  no_log: true
  ignore_errors: true

- name: 读取目录状态
  stat: 
    path: "{{ base_dir }}/down/rpms.tgz"
  register: rpms_dir_stat
  connection: local

- name: 准备离线基础安装包文件
  when: '"allinone" != DEPLOY_MODE and not rpms_dir_stat.stat.exists'
  ignore_errors: true
  block:  
  - name: 压缩rpm包
    archive:
      path: "{{ base_dir }}/down/rpms/"
      dest: "{{ base_dir }}/down/rpms.tgz"
    connection: local
    run_once: true

  - name: 复制rpm包
    copy: 
      src: "{{ base_dir }}/down/rpms.tgz" 
      dest: "{{ base_dir }}/down/rpms.tgz"

  - name: 解压rpm包
    unarchive:
      src: "{{ base_dir }}/down/rpms.tgz"
      dest: "{{ base_dir }}/down/rpms/"
      remote_src: yes

- name: rpm install for node
  shell: "{{ base_dir }}/down/rpms/rpminstall.sh 2 {{inventory_hostname not in groups.kube_master}} | cat"
  no_log: true
  ignore_errors: true
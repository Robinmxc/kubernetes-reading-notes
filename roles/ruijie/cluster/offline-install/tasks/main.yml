- name: 准备基础目录
  file: path={{ item }} state=directory
  connection: local
  with_items:
    - "{{base_dir}}"

- name: 准备下载目录
  file: path={{ item }} state=directory
  with_items:
    - "{{base_dir}}/down"
    - "{{base_dir}}/down/rpms"

- name: 准备临时文件目录
  file: path={{ item }} state=directory
  with_items:
    - "{{ temp_dir }}"

- name: 读取目录状态
  stat: path="{{base_dir}}/bin/kubectl"
  register: pkg_dir_stat
  connection: local

- name: 离线包软件安装
  copy: src={{ base_dir }}/rpminstall.sh dest={{ base_dir }}/down/rpms/
  with_items:
  - rpminstall.sh

- name: 设置离线包文件执行权限
  tags:
    - config
  file: name="{{ base_dir }}/down/rpms/{{ item }}" mode=0777
  with_items:
  - "rpminstall.sh"
#  run_once: true

- name: 准备k8s基础安装文件
  when: 'not pkg_dir_stat.stat.exists'
  run_once: true
  ignore_errors: true
  block:
    - name: 读取压缩包状态
      stat: path="{{base_dir}}/down/kad-support-files-{{ kad_support_files_version }}.tar.gz"
      register: tgz_info
    - name: 下载k8s基础文件
      get_url:
        url: "{{ KAD_FILES_REPO }}/kad/support/kad-support-files-{{ kad_support_files_version }}.tar.gz"
        dest: "{{base_dir}}/down/"
      when: 'not tgz_info.stat.exists'
    - name: 读取压缩包状态
      stat: path="{{base_dir}}/down/kad-support-files-{{ kad_support_files_version }}.tar.gz"
      register: tgz_info
    - name: 解压k8s基础文件
      unarchive:
        src: "{{base_dir}}/down/kad-support-files-{{ kad_support_files_version }}.tar.gz"
        dest: "{{base_dir}}/"
      when: 'tgz_info.stat.exists'

- name: 准备离线下载目录
  file: path={{ item }} state=directory
  with_items:
    - "{{ offline_dir }}"

- name: 读取离线安装标识
  stat: path="{{ offline_dir }}/offline-install.ok"
  register: offline_install_stat

- name: 读取离线压缩包状态
  stat: path="{{base_dir}}/down/kad-support-files-{{ kad_support_files_version }}.tar.gz"
  register: offline_tgz_info
  run_once: true


- name: 准备离线k8s基础安装文件
  when: '"allinone" != DEPLOY_MODE and not offline_install_stat.stat.exists and offline_tgz_info.stat.exists'
  ignore_errors: true
  block:
    - name: 设置下载标识
      file:
        path: "{{ offline_dir }}/offline-install.ok"
        state: touch
    - name: 复制压缩包到离线安装目录
      copy: src="{{base_dir}}/down/kad-support-files-{{ kad_support_files_version }}.tar.gz" dest="{{ offline_dir }}/kad-support-files-{{ kad_support_files_version }}.tar.gz"
      when: 'offline_tgz_info.stat.exists'
    - name: 读取离线目录压缩包状态
      stat: path="{{ offline_dir }}/kad-support-files-{{ kad_support_files_version }}.tar.gz"
      register: offline_dir_tgz_info
    - name: 解压离线压缩包
      unarchive:
        src: "{{ offline_dir }}/kad-support-files-{{ kad_support_files_version }}.tar.gz"
        dest: "{{ offline_dir }}/"
      when: 'offline_dir_tgz_info.stat.exists'

    - name: 删除离线安装包
      file:
        path: "{{ offline_dir }}/kad-support-files-{{ kad_support_files_version }}.tar.gz"
        state: absent
    - name: 读取离线目录bin目录状态
      stat: path="{{ offline_dir }}/bin"
      register: offline_dir_bin
    - name: 删除离线bin目录
      shell: "rm -rf {{ offline_dir }}/bin"
      when: 'offline_dir_bin.stat.exists'
    - name: 读取离线目录down目录状态
      stat: path="{{ offline_dir }}/down"
      register: offline_dir_down
    - name: 删除离线down目录
      shell: "rm -rf {{ offline_dir }}/down"
      when: 'offline_dir_down.stat.exists'

- name: 读取目录状态
  stat: 
    path: "{{ base_dir }}/down/rpms.tgz"
  register: rpms_dir_stat
  connection: local

- name: 准备离线k8s基础安装文件
  when: '"allinone" != DEPLOY_MODE and not rpms_dir_stat.stat.exists'
  ignore_errors: true
  block:  
  - name: 压缩rpm包
    archive:
      path: "{{ base_dir }}/down/rpms/"
      dest: "{{ base_dir }}/down/rpms.tgz"
    connection: local
    run_once: true

  - name: 复制rpm包
    copy: 
      src: "{{ base_dir }}/down/rpms.tgz" 
      dest: "{{ base_dir }}/down/rpms.tgz"

  - name: 解压rpm包
    unarchive:
      src: "{{ base_dir }}/down/rpms.tgz"
      dest: "{{ base_dir }}/down/rpms/"
      remote_src: yes

- name: rpm install for node
  shell: "{{ base_dir }}/down/rpms/rpminstall.sh 2 {{inventory_hostname not in groups.kube_master}}"
  no_log: true
  ignore_errors: true


- name: 读取基础工具压缩包状态
  stat: 
    path: "{{base_dir}}/down/kad-support-files-{{ kad_support_files_version }}.tar.gz"
  register: tgz_tools_info
  connection: local
  run_once: true
- name: 删除压缩包
  file:
    path: "{{ base_dir }}/down/kad-support-files-{{ kad_support_files_version }}.tar.gz"
    state: absent
  when: 'tgz_tools_info.stat.exists'
  connection: local
  run_once: true

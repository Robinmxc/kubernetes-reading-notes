- name: apt更新缓存刷新
  apt: update_cache=yes cache_valid_time=72000
  when: ansible_distribution == "Ubuntu" and ansible_distribution_major_version|int >= 16


- block:

  - name: 配置 chrony server 
    template: src=server-centos.conf.j2 dest=/etc/chrony.conf
    when: (ansible_distribution == "CentOS" or ansible_distribution == "RedHat") and ansible_distribution_major_version == "7"

  - name: 配置 chrony server 
    template: src=server-anolis.conf.j2 dest=/etc/chrony.conf
    when: ("Anolis"  in  ansible_distribution or "UOS"  in  ansible_distribution)

  - name: 配置 chrony server 
    template: src=server-ky10.conf.j2 dest=/etc/chrony.conf
    when: ("Kylin"  in  ansible_distribution )  

  - name: 配置 chrony server 
    template: src=server-openEuler.conf.j2 dest=/etc/chrony.conf
    when: ("openEuler"  in  ansible_distribution)  

  - name: 启动 chrony server
    service: name=chronyd state=restarted enabled=yes

  - name: 立即同步时间
    shell: "chronyc makestep"
  when: 'inventory_hostname == local_ntp_server'

- block:
  - name: 配置 chrony client
    template: src=client-centos.conf.j2 dest=/etc/chrony.conf
    when: (ansible_distribution == "CentOS" or ansible_distribution == "RedHat") and ansible_distribution_major_version == "7"


  - name: 配置 chrony client
    template: src=client-anolis.conf.j2 dest=/etc/chrony.conf
    when: ("Anolis"  in  ansible_distribution  or "UOS"  in  ansible_distribution)

  - name: 配置 chrony client
    template: src=client-ky10.conf.j2 dest=/etc/chrony.conf
    when: ("Kylin"  in  ansible_distribution )  

  - name: 配置 chrony client
    template: src=client-openEuler.conf.j2 dest=/etc/chrony.conf
    when: ("openEuler"  in  ansible_distribution)  

  - name: 启动 chrony client 
    service: name=chronyd state=restarted enabled=yes

  - name: 配置 rsyslog 
    template: src=rsyslog.conf dest=/etc/rsyslog.conf
    when: ("openEuler"  in  ansible_distribution)  

  - name: 立即同步时间
    shell: "chronyc makestep"
  when: 'inventory_hostname != local_ntp_server'

- name: 设置时区、更新硬件时钟、重启时间变动会影响到的服务
  shell: "timedatectl set-timezone Asia/Shanghai
   && timedatectl set-local-rtc 0
   && hwclock --systohc
   && hwclock -w
   && systemctl enable chronyd
   && systemctl restart chronyd 
   && systemctl restart crond
   && systemctl restart rsyslog"
  ignore_errors: true
  when: ("Kylin"  in  ansible_distribution )  

- name: 设置时区、更新硬件时钟、重启时间变动会影响到的服务
  shell: "timedatectl set-timezone Asia/Shanghai
   && timedatectl set-local-rtc 0
   && hwclock --systohc
   && hwclock -w
   && systemctl enable chronyd
   && systemctl restart chronyd 
   && systemctl restart crond
   && systemctl restart rsyslog"
  ignore_errors: true
  when: ("Anolis"  in  ansible_distribution or "UOS"  in  ansible_distribution)

- name: 设置时区、更新硬件时钟、重启时间变动会影响到的服务
  shell: "timedatectl set-timezone Asia/Shanghai
   && timedatectl set-local-rtc 0
   && timedatectl set-ntp yes
   && hwclock --systohc
   && hwclock -w
   && systemctl restart crond
   && systemctl restart rsyslog"
  ignore_errors: true
  when: ("openEuler"  in  ansible_distribution )  

  
- name: 设置时区、更新硬件时钟、重启时间变动会影响到的服务
  shell: "timedatectl set-timezone Asia/Shanghai
   && timedatectl set-local-rtc 0
   && timedatectl set-ntp yes
   && hwclock --systohc
   && hwclock -w
   && systemctl restart crond
   && systemctl restart rsyslog"
  ignore_errors: true
  when: (ansible_distribution == "CentOS" or ansible_distribution == "RedHat") and ansible_distribution_major_version == "7"
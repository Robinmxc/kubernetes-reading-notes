- name: 删除centos/redhat默认安装
  yum: 
    name: 
      - firewalld
      - python-firewall
      - firewalld-filesystem
    state: absent

- name: 添加EPEL仓库
  yum: name=epel-release state=present

- name: 安装基础软件包
  yum: 
    name: 
      - conntrack-tools     # ipvs 模式需要
      - psmisc        # 安装psmisc 才能使用命令killall，它在keepalive的监测脚本中使用到
      - nfs-utils     # 挂载nfs 共享文件需要 (创建基于 nfs的PV 需要)
      - jq                  # 轻量JSON处理程序，安装docker查询镜像需要
      - socat               # 用于port forwarding
      - bash-completion     # bash命令补全工具，需要重新登录服务器生效
      - rsync               # 文件同步工具，分发证书等配置文件需要
      - ipset
      - ipvsadm
      - net-tools
      - unzip
    state: present
  when: '"sourceid" == KAD_APP_NAME'
- name: 查询防火墙状态
  shell: "systemctl list-units *.service"
  register: firewall_info

- name: 关闭防火墙
  shell: "systemctl stop firewalld && systemctl disable firewalld"
  when: '"firewalld" in firewall_info.stdout'
  ignore_errors: true

- name: 清理防火墙规则
  shell: "iptables -F && iptables -X && iptables -F -t nat && iptables -X -t nat"
  ignore_errors: true

- name: 设置默认转发策略
  shell: "iptables -P FORWARD ACCEPT"
  ignore_errors: true

- name: 临时关闭 selinux
  shell: "setenforce 0"
  failed_when: false

- name: 永久关闭 selinux
  lineinfile:
    dest: /etc/selinux/config
    regexp: "^SELINUX="
    line: "SELINUX=disabled"

- name: 获取autostart.sh状态
  stat: path="/etc/init.d/autostart.sh"
  register: data_dir_stat  

- name: 初次执行autostart.sh脚本
  shell: sh /etc/init.d/autostart.sh
  when: 'data_dir_stat.stat.exists'
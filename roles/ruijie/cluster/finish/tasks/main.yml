- name: 执行集群创建成功以后的一些后置任务
  when: '"" != KUBE_MASTER_VIP and DEPLOY_MODE == "multi-master" '
  block:
    - name: 在执行节点创建keepalived相关目录
      file: path=/opt/kube/kube-system/keepalived state=directory

    # service文件中externalIPs是动态指定，因此需要用template模块替换参数
    - name: 准备keepalived service文件
      template: src=keepalived-svc.yaml.j2 dest=/opt/kube/kube-system/keepalived/keepalived-svc.yaml

    - name: 创建keepalived service资源
      shell: "kubectl apply -f /opt/kube/kube-system/keepalived"

    - name: Patch external VIP for dashboard service
      shell: "kubectl patch svc kubernetes-dashboard -n kube-system -p '{\"spec\": {\"externalIPs\":[\"{{KUBE_MASTER_VIP}}\"]}}'"
  delegate_to: "{{ groups.deploy[0] }}"
  run_once: true
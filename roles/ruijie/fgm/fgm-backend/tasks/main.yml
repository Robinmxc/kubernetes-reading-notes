- name: 部署
  when: 'FGM_BACKEND_ENABLE == "yes"'
  block:
  - name: 复制配置文件
    tags:
      - config
    copy:
      src: "{{ namespace_dir }}/conf/sourceid/fgm-backend/conf/"
      dest: "{{ config_base_dir }}/sourceid/fgm-backend/conf/"

  - name: 修改配置文件
    tags:
      - config
    replace: path="{{ config_base_dir }}/sourceid/fgm-backend/conf/application.yml" regexp="{{ item.regexp }}" replace="{{ item.replace }}"
    with_items:
      - {regexp: "kube-ruijie.svc", replace: "{{ APP_NAMESPACE }}.svc"}
      - {regexp: "mongodb:.*/linkid-dev.*$", replace: "mongodb://{{ SOURCEID_LINKID_DB_USER }}:{{ SOURCEID_LINKID_DB_PWD }}@{{ mongodb_addr }}/linkid-dev?replicaSet=rs0"}
      - {regexp: "mysql:.*/epidemic_situation_information", replace: "mysql://{{ fgm_db_user }}:{{ fgm_db_pwd }}@{{ fgm_db_host }}/{{fgm_db_name}}"}
      - {regexp: "table-name:.*sid_user_info.*$", replace: "table-name: {{SOURCEDATA_USER_SYNC_TABLE_NAME}}"}
      - {regexp: "db-name:.*epidemic_situation_information.*$", replace: "db-name: {{fgm_db_name}}"}
    no_log: true

  - name: 准备部署文件目录
    tags:
      - config
    file: path={{ item }} state=directory
    with_items:
      - "{{ yaml_dir }}/fgm-backend"
    run_once: true
    connection: local

  - name: 准备部署文件
    tags:
      - config
    vars:
      deploy_conf: '{{ fgm_backend_deploy_conf }}'
    template: src='fgm-backend.yaml.j2' dest={{ yaml_dir }}/fgm-backend/fgm-backend.yml
    run_once: true
    connection: local

  - name: 获取所有已经创建的POD信息
    tags:
      - deploy
    command: "{{ bin_dir }}/kubectl get pod -n {{ APP_NAMESPACE }}"
    register: pod_info
    run_once: true
    connection: local

  - name: 执行部署
    tags:
      - deploy
    shell: "{{ bin_dir }}/kubectl apply -f {{ yaml_dir }}/fgm-backend/"
    when: 'pod_info.stdout is not search("rg-fgm-backend-[a-z0-9]*-[a-z0-9]*\s*[0-9]*/[0-9]*\s*Running")'
    run_once: true
    connection: local

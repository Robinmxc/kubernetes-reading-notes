- name: 创建切割日志和清理日志脚本
  copy:
    dest: "/opt/split.sh"
    content: |
      #!/bin/sh
      # 拷贝日志文件到 昨天的log中 -b  split 可以进行文件切割，如果不需要文件的切割可以将 split -b 100k -d 换成 cp ，-b指定单个文件大小，-d 指定如果单个文件过
      大，进行切割时文件的后缀为数字
      split -b 10M -d -a 3 {{ config_base_dir }}/freeradius/log/radius.log {{ config_base_dir }}/freeradius/log/radius.`date -d yesterday +%Y%m%d`.log
      # 清空日志
      cat /dev/null > {{ config_base_dir }}/freeradius/log/radius.log
      # 删除超过45天的日志
      find {{ config_base_dir }}/freeradius/log/ -mtime +45 -name "radius.*.log*" -exec rm -rf {} \;

- name: "定时切割日志和清理日志定时任务"
  ansible.builtin.cron:
    name: "split"
    state: present
    minute: "0"
    hour: "2"
    day: "*"
    month: "*"
    weekday: "*"
    job: 'sh /opt/split.sh'

- name: 复制配置文件
  tags:
  - config
  copy:
    src: "{{ namespace_dir }}/conf/freeradius/"
    dest: "{{ config_base_dir }}/freeradius/"

- name: 准备部署文件目录
  tags:
  - config
  file: path={{ item }} state=directory
  with_items:
  - "{{ yaml_dir }}/freeradius"
  run_once: true
  connection: local

- name: 准备部署文件
  tags:
  - config
  vars:
    deploy_conf: '{{freeradius_deploy_conf}}'
    comp_name: 'freeradius'
  template: src='freeradius.yaml.j2' dest={{ yaml_dir }}/freeradius/freeradius.yml
  run_once: true
  connection: local

- name: 获取所有已经创建的POD信息
  tags:
  - deploy
  command: "{{ bin_dir }}/kubectl get pod -n {{ APP_NAMESPACE }}"
  register: pod_info
  run_once: true
  connection: local

- name: 执行部署
  tags:
  - deploy
  shell: "{{ bin_dir }}/kubectl apply -f {{ yaml_dir }}/freeradius/"
  when: '"rg-freeradius" not in pod_info.stdout'
  run_once: true
  connection: local

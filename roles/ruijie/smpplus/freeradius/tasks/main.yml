- name: 创建切割日志和清理日志脚本
  copy:
    dest: "/opt/split.sh"
    content: |
      #!/bin/sh
      \cp -rpf /dev/null  {{ config_base_dir }}/freeradius/log/radwtmp
      log_dir="{{ config_base_dir }}/freeradius/log/radacct/"
      threshold_days=7
      
      find "$log_dir" -type d -print0 | while IFS= read -r -d '' directory; do
        find "$directory" -type f -mtime +"$threshold_days" -print0 | while IFS= read -r -d '' file; do
          rm "$file"
        done
      done
      # 拷贝日志文件到昨天的log中，split可以进行文件切割，-b指定单个文件大小，-d指定如果单个文件过大，进行切割时文件的后缀为数字
      split -b 10M -d -a 3 {{ config_base_dir }}/freeradius/log/radius.log {{ config_base_dir }}/freeradius/log/radius.`date -d yesterday +%Y%m%d`.log
      # 清空日志
      cat /dev/null > {{ config_base_dir }}/freeradius/log/radius.log
      # 删除超过60天的日志
      find {{ config_base_dir }}/freeradius/log/ -mtime +60 -name "radius.*.log*" -exec rm -rf {} \;

- cron:
    name: "split"
    state: present
    minute: "0"
    hour: "2"
    day: "*"
    month: "*"
    weekday: "*"
    job: 'sh /opt/split.sh'

- name: 复制配置文件
  tags:
  - config
  copy:
    src: "{{ namespace_dir }}/conf/freeradius/"
    dest: "{{ config_base_dir }}/freeradius/"

- name: 准备部署文件目录
  tags:
  - config
  file: path={{ item }} state=directory
  with_items:
  - "{{ yaml_dir }}/freeradius"
  run_once: true
  connection: local

- name: 准备部署文件
  tags:
  - config
  vars:
    deploy_conf: '{{freeradius_deploy_conf}}'
    comp_name: 'freeradius'
  template: src='freeradius.yaml.j2' dest={{ yaml_dir }}/freeradius/freeradius.yml
  run_once: true
  connection: local

- name: 获取所有已经创建的POD信息
  tags:
  - deploy
  command: "kubectl get pod -n {{ APP_NAMESPACE }}"
  register: pod_info
  run_once: true
  connection: local

- name: 执行部署
  tags:
  - deploy
  shell: "kubectl apply -f {{ yaml_dir }}/freeradius/"
  when: '"rg-freeradius" not in pod_info.stdout'
  run_once: true
  connection: local

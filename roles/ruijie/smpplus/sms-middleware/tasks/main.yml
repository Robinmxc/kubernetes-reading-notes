- name: 部署sms-middleware
  when: 'SMPPLUS_SMS_MIDDLEWARE_ENABLED == "yes"'
  block:
  - name: 复制配置文件
    tags:
    - config
    copy:
      src: "{{ namespace_dir }}/conf/sms-middleware/conf/"
      dest: "{{ config_base_dir }}/sms-middleware/conf/"

  - name: 自动配置
    tags:
    - config
    replace: path="{{ config_base_dir }}/sms-middleware/conf/application-prd.yml" regexp="{{ item.regexp }}" replace="{{ item.replace }}"
    with_items:
    - {regexp: "mongodb:.*/nodes.*$", replace: "mongodb://{{ MONGODB_ADMIN_USER }}:{{ MONGODB_ADMIN_PWD }}@{{ mongodb_addr }}/nodes?replicaSet=rs0"}
    - {regexp: "mongodb:.*/license.*$", replace: "mongodb://{{ MONGODB_ADMIN_USER }}:{{ MONGODB_ADMIN_PWD }}@{{ mongodb_addr }}/license?replicaSet=rs0"}
    - {regexp: "mongodb:.*/component.*$", replace: "mongodb://{{ MONGODB_ADMIN_USER }}:{{ MONGODB_ADMIN_PWD }}@{{ mongodb_addr }}/component?replicaSet=rs0"}
    - {regexp: "mongodb:.*/linkid-dev.*$", replace: "mongodb://{{ MONGODB_ADMIN_USER }}:{{ MONGODB_ADMIN_PWD }}@{{ mongodb_addr }}/linkid-dev?replicaSet=rs0"}
    - {regexp: "mongodb:.*/linkid-job.*$", replace: "mongodb://{{ MONGODB_ADMIN_USER }}:{{ MONGODB_ADMIN_PWD }}@{{ mongodb_addr }}/linkid-job?replicaSet=rs0"}
    - {regexp: "protectEnable.*$", replace: "protectEnable: {{ protectEnable_value }}"}
    - {regexp: "whiteHost.*$", replace: "whiteHost: {{allNodeStr}}"}
    no_log: true

  - name: 自定义配置
    tags:
    - config
    replace:
      path: '{{ config_base_dir }}/sms-middleware/conf/application-prd.yml'
      regexp: '{% if item.regexp is defined %}{{item.regexp}}{% else %}{{ item.name }}\s*=.*${% endif %}'
      replace: '{% if item.regexp is defined %}{{item.value}}{% else %}{{ item.name }}={{item.value}}{% endif %}'
    with_items: '{{ sms_middleware_configs }}'
    no_log: true

  - name: 准备部署文件目录
    tags:
    - config
    file: path={{ item }} state=directory
    with_items:
    - "{{ yaml_dir }}/sms-middleware"
    run_once: true
    connection: local

  - name: 准备部署文件
    tags:
    - config
    vars:
      deploy_conf: '{{sms_middleware_deploy_conf}}'
      JAVA_OPT_EXT: '{{sms_middleware_java_opt}}'
      comp_name: 'sms-middleware'
    template: src='sms-middleware.yaml.j2' dest={{ yaml_dir }}/sms-middleware/sms-middleware.yml
    run_once: true
    connection: local

  - name: 获取所有已经创建的POD信息
    tags:
    - deploy
    command: "kubectl get pod -n {{ APP_NAMESPACE }}"
    register: pod_info
    run_once: true
    connection: local

  - name: 执行部署
    tags:
    - deploy
    shell: "kubectl apply -f {{ yaml_dir }}/sms-middleware/"
    when: '"rg-sms-middleware" not in pod_info.stdout'
    run_once: true
    connection: local

- name: 读取daemon.json
  command: "cat /etc/docker/daemon.json"
  register: daemon_json

- block:
    - name: 准备daemon.json
      replace:
        path: '/etc/docker/daemon.json'
        regexp: '^.*insecure-registries.*$'
        replace: '  "insecure-registries": ["{{ PRIVATE_INSECURE_REGISTRY }}"],'
    - name: 重新加载服务配置
      command: "systemctl daemon-reload"
    - name: 重启docker服务
      service: name=docker state=restarted
    - name: 登录docker仓库
      command: "docker login -u {{ PRIVATE_REGISTRY_USER }} -p {{ PRIVATE_REGISTRY_PWD }} {{ PRIVATE_INSECURE_REGISTRY }}"
  when: '"yes" == PRIVATE_REGISTRY_ENABLED and PRIVATE_INSECURE_REGISTRY not in daemon_json.stdout'

- name: 复制镜像
  when: '"single" != CLUSTER_SCALE'
  block:
  - name: 准备镜像复制目录
    file: path={{ item }} state=directory
    with_items:
    - "{{ img_copy_dir }}"

  - name: 获取已复制的镜像文件信息
    command: "ls {{ img_copy_dir}}"
    register: images_copy_info

  - name: 复制镜像文件
    vars:
      comp_name: "{{ item }}"
      docker_version: "{{ SMPPLUS_DOCKERS[comp_name].version }}"
      img_file_name: "{{ comp_name }}-{{ docker_version }}.tar"
    copy: src={{ img_download_dir }}/{{ img_file_name }} dest={{ img_copy_dir }}/{{ img_file_name }}
    when: '"" != docker_version and img_file_name not in images_copy_info.stdout'
    with_items: "{{ SMPPLUS_DOCKERS }}"

- name: 获取docker已加载的镜像信息
  command: "docker images --format ''{{ '{{' }}.Repository{{ '}}' }}:{{ '{{' }}.Tag{{ '}}' }}''"
  register: imgages_info

- name: 加载镜像
  vars:
    comp_name: "{{ item }}"
    docker_version: "{{ SMPPLUS_DOCKERS[comp_name].version }}"
    img_id_ver: "{{ PRIVATE_INSECURE_REGISTRY }}/{{ SMPPLUS_DOCKERS[comp_name].name }}:{{ docker_version }}"
    img_file_name: "{{ comp_name }}-{{ docker_version }}.tar"
    img_dir: '{% if "single" == CLUSTER_SCALE %}{{ img_download_dir }}{% else %}{{ img_copy_dir }}{% endif %}'
  command: 'docker load -i {{ img_dir }}/{{ img_file_name }}'
  when: '"" != docker_version and img_id_ver not in imgages_info.stdout'
  with_items: "{{ SMPPLUS_DOCKERS }}"

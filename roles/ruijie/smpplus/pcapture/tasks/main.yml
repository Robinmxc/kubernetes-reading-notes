- name: 部署pcapture
  when: 'PCAPTURE_ENABLE == "yes"'
  block:
  - name: 复制配置文件
    tags:
      - config
    copy:
      src: "{{ namespace_dir }}/conf/{{ item }}/conf/"
      dest: "{{ config_base_dir }}/{{ item }}/conf/"
    with_items:
      - "pcapture"


  - name: 自动配置
    tags:
      - config
    vars:
      grab_ip: "{{ deploy_ip }}"
    replace: path="{{ config_base_dir }}/pcapture/conf/application-pro.yml" regexp="{{ item.regexp }}" replace="{{ item.replace }}"
    with_items:
      - {regexp: "mongodb:.*/linkid-dev.*$", replace: "mongodb://{{ MONGODB_ADMIN_USER }}:{{ MONGODB_ADMIN_PWD }}@{{ groups.mongodb[0] }}:27017/linkid-dev?replicaSet=rs0"}
      - {regexp: "baseDir: .*$", replace: "baseDir: /ruijie/pcapture/conf/dumpPackage/"}
      - {regexp: "tarDir: .*$", replace: "tarDir: /ruijie/pcapture/conf/dumpPackage/tars/"}
      - {regexp: "kube-ruijie.svc", replace: "{{ APP_NAMESPACE }}.svc"}
      - {regexp: "grabIp: .*$", replace: "grabIp: {{ grab_ip }}"}
    no_log: true

  - name: 准备部署文件目录
    tags:
      - config
    file: path={{ item }} state=directory
    with_items:
    - "{{ yaml_dir }}/pcapture"
    run_once: true
    connection: local

  - name: 准备部署文件
    tags:
      - config
    vars:
      pcapture_node_name: "rg-pcapture"
      deploy_conf: '{{ pcapture_deploy_conf }}'
      comp_name: 'pcapture'
    template: src='{{ pcapture_templates_path }}pcapture.yaml.j2' dest={{ yaml_dir }}/pcapture/pcapture.yml
    run_once: true
    connection: local

  - name: 获取所有已经创建的POD信息
    tags:
      - deploy
    command: "kubectl get pod -n {{ APP_NAMESPACE }}"
    register: pod_info
    run_once: true
    connection: local

  - name: 执行部署
    tags:
      - deploy
    shell: "kubectl apply -f {{ yaml_dir }}/pcapture/"
    run_once: true
    connection: local
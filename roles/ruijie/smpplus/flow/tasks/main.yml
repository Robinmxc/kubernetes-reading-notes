- name: 部署探针
  when: 'FLOW_PORT_MODE != 0'
  block:
  - name: 复制配置文件
    tags:
    - config
    copy:
      src: "{{ namespace_dir }}/conf/flow/"
      dest: "{{ config_base_dir }}/flow/"

  - name: 自动配置
    tags:
    - config
    replace: path="{{ config_base_dir }}/flow/conf/config.json" regexp="{{ item.regexp }}" replace="{{ item.replace }}"
    with_items:
    - {regexp: "hostname\".*$", replace: "hostname\":\"{{groups['kube_node'][0]}}\","}
    - {regexp: "coreMask\".*$", replace: "coreMask\":{{FLOW_PORT_MODE}}"}
    no_log: true


  - name: 自定义配置
    tags:
    - config
    replace:
      path: '{{ config_base_dir }}/flow/conf/config.json'
      regexp: '{% if item.regexp is defined %}{{item.regexp}}{% else %}{{ item.name }}\s*=.*${% endif %}'
      replace: '{% if item.regexp is defined %}{{item.value}}{% else %}{{ item.name }}={{item.value}}{% endif %}'
    with_items: '{{ nodeidentify_configs }}'
    no_log: true

  - name: 准备部署文件目录
    tags:
    - config
    file: path={{ item }} state=directory
    with_items:
    - "{{ yaml_dir }}/flow"
    run_once: true
    connection: local


  - name: 执行部署
    tags:
    - deploy
    shell: 'docker run --restart always  -itd -v /home/ruijie/ruijie-smpplus/flow:/ruijie/flow --cpus=8  -m 4096m --net=host --privileged=true --name flow --entrypoint /app/startup.sh {{ PRIVATE_INSECURE_REGISTRY }}/{{ SMPPLUS_DOCKERS["flow"].name }}:{{ SMPPLUS_DOCKERS["flow"].version }}'
    run_once: true
    connection: local
    when: 'FLOW_PORT_MODE == 511'
  - name: 执行部署
    tags:
      - deploy
    shell: 'docker run --restart always  -itd -v /home/ruijie/ruijie-smpplus/flow:/ruijie/flow --cpus=4  -m 4096m --net=host --privileged=true --name flow --entrypoint /app/startup.sh {{ PRIVATE_INSECURE_REGISTRY }}/{{ SMPPLUS_DOCKERS["flow"].name }}:{{ SMPPLUS_DOCKERS["flow"].version }}'
    run_once: true
    connection: local
    when: 'FLOW_PORT_MODE != 511'

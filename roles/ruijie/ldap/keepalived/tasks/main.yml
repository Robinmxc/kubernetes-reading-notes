- name: 部署keepalived
  when: '"" != LDAP_VIP'
  block:
  - name: 准备目录
    file: name={{ item }} state=directory
    with_items:
     - "{{ base_dir }}/down/rpms/common"

  - name: 解压 rpm 包
    vars:
      tgz_file: '{{ base_dir }}/down/common/nginx.tar.gz'
      src_dir: '{{ base_dir }}/down/rpms/common/nginx/'
    unarchive:
      src: "{{ tgz_file }}"
      dest: "{{ base_dir }}/down/rpms/common"
    when: 'tgz_file is exists'

  - name: 安装 rpm
    shell: "{{ base_dir }}/down/rpms/common/nginx/common-nginx-install.sh"

  - name: 读取网卡名称
    shell: "ip a|grep '{{ inventory_hostname }}/'|awk '{print $NF}'"
    register: if_info

  - name: 设置负载均衡网卡
    set_fact: LDAP_ACCESS_IF="{{ if_info.stdout }}"

  - name: 创建keepalived目录
    file: name=/etc/keepalived state=directory

  - name: 设置keepalived配置文件
    template: src=keepalived.conf.j2 dest=/etc/keepalived/keepalived.conf

  - name: 设置slapd存活检测脚本
    template: src=ldap_check.sh.j2 dest=/etc/keepalived/ldap_check.sh mode=755

  - name: 设置keepalived服务拉起脚本
    template: src=keepalived_up.sh.j2 dest=/etc/keepalived/keepalived_up.sh mode=755

  - name: crontab清理eepalived服务拉起脚本
    shell: sed -i '/keepalived_up/d' /var/spool/cron/root

  - name: crontab添加keepalived服务拉起脚本
    shell: echo '* * * * * /etc/keepalived/keepalived_up.sh' >> /var/spool/cron/root

  - name: 启动服务
    service: name={{ item }} state=started enabled=yes
    with_items:
      - keepalived
    ignore_errors: true

worker_processes  1;
events {
    worker_connections  1024;
}

# 配置tcp
stream {

    log_format proxy '$remote_addr [$time_local] '
                 '$protocol $status $bytes_sent $bytes_received '
                 '$session_time "$upstream_addr" '
                 '"$upstream_bytes_sent" "$upstream_bytes_received" "$upstream_connect_time"';

    access_log  {{ DATA_DIR }}/nginx/logs/access.log proxy;

    upstream slapd {
        hash $remote_addr consistent;
        server 127.0.0.1:{{ port }} max_fails=3 fail_timeout=30s;
    }
    server {
        listen {{ LDAP.LDAP_PORT }};
        proxy_connect_timeout 6s;
        #proxy_timeout 30s;
        proxy_pass slapd;
    }
}

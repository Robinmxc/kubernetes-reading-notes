- name: 安装nginx依赖配置
  yum:
    state: present
    name:
    - gcc
    - gcc-c++
    - make
    - automake
    - autoconf
    - libtool
    - pcre
    - pcre-devel
    - zlib
    - zlib-devel
    - openssl-devel
    - wget

- name: 下载nginx源码
  vars:
    tgz_file: '{{ base_dir }}/down/nginx-{{ ldap_nginx_version }}.tar.gz'
  get_url:
    url: "http://nginx.org/download/nginx-{{ ldap_nginx_version }}.tar.gz"
    dest: "{{ tgz_file }}"
  connection: local
  run_once: true
  when: 'tgz_file is not exists'

- name: 解压nginx源码
  vars:
    #下载压缩包目录
    tgz_file: '{{ base_dir }}/down/nginx-{{ ldap_nginx_version }}.tar.gz'
    #nginx安装目录
    src_dir: '{{ NGINX_SRC_PATH }}/nginx-{{ ldap_nginx_version }}'
  unarchive:
    src: "{{ tgz_file }}"
    dest: "{{ NGINX_SRC_PATH }}"
  when: 'tgz_file is exists and src_dir is not exists'

- name: 安装nginx
  shell: "./configure && make && make install"
  args:
    chdir: "{{ NGINX_SRC_PATH }}/nginx-{{ ldap_nginx_version }}"
  when: '"/usr/local/nginx/sbin/nginx" is not exists'

- name: 安装stream模块
  shell: "./configure --with-stream && make && make install"
  args:
    chdir: "{{ NGINX_SRC_PATH }}/nginx-{{ ldap_nginx_version }}"
  when: '"/usr/local/nginx/sbin/nginx" is not exists'

- name: 检查nginx服务状态
  stat: path="/etc/systemd/system/multi-user.target.wants/nginx.service"
  register: service_stat

- name: 部署nginx
  when: 'not service_stat.stat.exists'
  block:
  - name: 设置nginx参数
    vars:
      ldap_1_hostname: "{{ groups.ldap[0] }}"
      ldap_2_hostname: "{{ groups.ldap[1] }}"
      port: "{{ ldap_dual_mode_port }}"
    template:
      src: 'nginx.conf.j2'
      dest: /usr/local/nginx/conf/nginx.conf

  - name: 创建nginx服务
    template: src=nginx.service.j2 dest=/etc/systemd/system/nginx.service

  - name: 开机启用nginx服务
    shell: systemctl enable nginx

  - name: 开启nginx服务
    shell: systemctl daemon-reload && systemctl restart nginx

  - name: 轮询等待nginx服务运行
    shell: "systemctl status nginx.service|grep Active"
    register: service_status
    until: '"running" in service_status.stdout'
    retries: 8
    delay: 2

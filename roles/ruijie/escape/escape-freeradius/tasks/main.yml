- name: 创建切割日志和清理日志脚本
  copy:
    dest: "/opt/split.sh"
    content: |
      #!/bin/sh
      # 拷贝日志文件到昨天的log中，split可以进行文件切割，-b指定单个文件大小，-d指定如果单个文件过大，进行切割时文件的后缀为数字
      split -b 10M -d -a 3 {{ config_base_dir }}/escape-freeradius/log/radius.log {{ config_base_dir }}/escape-freeradius/log/radius.`date -d yesterday +%Y%m%d`.log
      # 清空日志
      cat /dev/null > {{ config_base_dir }}/escape-freeradius/log/radius.log
      # 删除超过60天的日志
      find {{ config_base_dir }}/escape-freeradius/log/ -mtime +60 -name "radius.*.log*" -exec rm -rf {} \;

- cron:
    name: "split"
    state: present
    minute: "0"
    hour: "2"
    day: "*"
    month: "*"
    weekday: "*"
    job: 'sh /opt/split.sh'

- name: 复制配置文件
  tags:
  - config
  copy:
    src: "{{ namespace_dir }}/conf/escape-freeradius/"
    dest: "{{ config_base_dir }}/escape-freeradius/"

- name: 准备部署文件目录
  tags:
  - config
  file: path={{ item }} state=directory
  with_items:
  - "{{ yaml_dir }}/escape-freeradius"
  run_once: true
  connection: local

- name: 准备部署文件
  tags:
  - config
  vars:
    deploy_conf: '{{escape_freeradius_deploy_conf}}'
    comp_name: 'escape-freeradius'
  template: src='escape-freeradius.yaml.j2' dest={{ yaml_dir }}/escape-freeradius/escape-freeradius.yml
  run_once: true
  connection: local

- name: 获取所有已经创建的POD信息
  tags:
  - deploy
  command: "kubectl get pod -n {{ APP_NAMESPACE }}"
  register: pod_info
  run_once: true
  connection: local

- name: 执行部署
  tags:
  - deploy
  shell: "kubectl apply -f {{ yaml_dir }}/escape-freeradius/"
  when: '"rg-escape-freeradius" not in pod_info.stdout'
  run_once: true
  connection: local

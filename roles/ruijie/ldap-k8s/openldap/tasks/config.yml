- name: 准备LDAP配置文件
  block:
    - name: 准备LDAP存储目录
      file: path={{ item }} state=directory
      with_items:
        - "{{ ldap_base_dir }}/schema"
        - "{{ ldap_base_dir }}/conf"
        - "{{ ldap_base_dir }}/data"
        - "{{ ldap_base_dir }}/certs"

    - name: 准备schema配置文件
      tags:
        - config
      vars:
        filename: '{{ item }}'
      template:
        src: '{{ filename }}.j2'
        dest: '{{ ldap_base_dir }}/schema/{{ filename }}'
      with_items:
        #- "01_add_ppolicy.ldif"
        - "02_modify_ppolicy.ldif"
        - "03_ppolicy_overlay.ldif"
        #- "04_disable_anon.ldif"
        - "05_db-index.ldif"
        - "06_limits.ldif"
        #- "07_tls1.2.ldif"
        #- "08_name.ldif"
        - "09_olcAccess.ldif"

    - name: 生成双主特殊配置文件
      when: "groups.ldap | length >= 2 "
      vars:
        filename: '{{ item }}'
        ldap_1_hostname: "{{ groups.ldap[0] }}"
        ldap_2_hostname: "{{ groups.ldap[1] }}"
      template:
        src: '{{ filename }}.j2'
        dest: '{{ ldap_base_dir }}/schema/{{ filename }}'
      with_items:
        - "100_mod_syncprov.ldif"
        - "101_syncprov.ldif"
        - "102_master_node.ldif"
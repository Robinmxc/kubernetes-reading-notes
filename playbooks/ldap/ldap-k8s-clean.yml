- hosts:
    - localhost
  gather_facts: false
  vars_files:
    - "/etc/kad/config.yml"

  tasks:
    - name: 获取所有部署的Pod信息
      command: "kubectl get pod -n {{ APP_NAMESPACE }}"
      register: pod_info

    - name: 停止openldap
      command: "kubectl delete -f {{ yaml_dir }}/openldap/"
      when: '"openldap" in pod_info.stdout'

    - name: 等待openldap结束运行
      shell: "kubectl get pod -n {{ APP_NAMESPACE }}"
      register: pod_info
      until: '"openldap" not in pod_info.stdout'
      retries: 30
      delay: 3
      ignore_errors: true

    - name: delete secret
      shell: "kubectl delete secrets ldap-pwds -n {{ APP_NAMESPACE }} --ignore-not-found"
      ignore_errors: true

- hosts:
    - ldap
  gather_facts: false
  vars_files:
    - "/etc/kad/config.yml"
  tasks:
    - name: 备份ldap数据
      vars:
        data_dir: "{{ current_data_dir.stdout | trim}}"
      archive:
        path: "{{ ldap_base_dir }}"
        dest: "{{ ldap_backup_dir }}/ldap_backup_{{ current_datetime.stdout }}.tar.gz"
        format: gz

    - name: 删除ldap数据
      file: name="{{ ldap_base_dir }}" state=absent
      ignore_errors: true

    - name: 清理keepalived配置
      shell: sed -i '/keepalived_up/d' /var/spool/cron/root

    - name: 停止keepalived服务
      service: name=keepalived state=stopped enabled=no
      ignore_errors: true
# cluster-restore playbook
# read the guide: 'op/cluster_restore.md'

# to restore CA sth on 'deploy' node
- hosts: deploy
  tasks: 
  - name: Restoring dirs of CA sth
    file: name=/etc/kubernetes/ssl/ state=directory

  - name: Restoring CA sth
    copy: 
      src: "{{ base_dir }}/roles/cluster-backup/files/ca/{{ item }}"
      dest: "{{ ca_dir }}/{{ item }}"
    with_items:
    - ca.pem
    - ca-key.pem
    - ca.csr
    - ca-csr.json
    - ca-config.json

- hosts: deploy
  roles:
  - deploy

# pre-tasks on all nodes
- hosts: all
  roles:
  - prepare

# [optional] only needed by multi-master cluster
- hosts: lb
  roles:
  - lb

# to install etcd cluster
- hosts: etcd
  roles:
  - etcd

# to install docker
- hosts:
  - kube_master
  - kube_node
  roles:
  - docker

# to set up 'kube_master' nodes
- hosts:
  - kube_master
  roles:
  - kube_master
  - kube_node
  # 
  tasks:
  - name: Making master nodes SchedulingDisabled
    shell: "kubectl cordon {{ inventory_hostname }} "
    when: DEPLOY_MODE != "allinone"
    ignore_errors: true

  - name: Setting master role name
    shell: "kubectl label node {{ inventory_hostname }} kubernetes.io/role=master --overwrite"
    ignore_errors: true

# to set up 'kube_node' nodes
- hosts:
  - kube_node
  roles:
  - kube_node

# to restore data of etcd cluster
- hosts: etcd
  roles:
  - cluster-restore


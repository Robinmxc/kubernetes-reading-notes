- hosts:
  - kube_node
  - kube_master
  tasks:
  - name: 删除自动执行脚本
    shell: "sed -i '/{{ item }}/d' /var/spool/cron/root"
    with_items:
      - "componentVersion.sh"
      - "kubectlCmd.sh"
      - "system_date.sh"
      - "oneAuthCertDate.sh"
      - "httpsCertDate.sh"
    ignore_errors: true

- hosts:
  - localhost
  tasks:
  - name: 获取所有已经创建的POD信息
    tags: always
    command: "{{ bin_dir }}/kubectl get pod -n monitoring"
    register: pod_info

  - name: 停止prometheus pushgateway
    command: "{{ bin_dir }}/kubectl delete -f {{ prometheus_default_dir }}/prometheus/pushgateway/"
    when: '"prometheus" in pod_info.stdout'

  - name: 停止prometheus k8score-metrics
    command: "{{ bin_dir }}/kubectl delete -f {{ prometheus_default_dir }}/prometheus/k8score-metrics/"
    when: '"prometheus" in pod_info.stdout'

  - name: 停止prometheus manifests
    command: "{{ bin_dir }}/kubectl delete -f {{ prometheus_default_dir }}/prometheus/manifests/"
    when: '"prometheus" in pod_info.stdout'

  - name: 停止prometheus manifests setup
    command: "{{ bin_dir }}/kubectl delete -f {{ prometheus_default_dir }}/prometheus/manifests/setup/"
    when: '"prometheus" in pod_info.stdout'

- hosts:
  - eoms
  tasks:
  - name: 禁用grafana
    shell: systemctl disable grafana-server
    ignore_errors: true
  
  - name: 停止 grafana 服务
    shell: systemctl daemon-reload && systemctl stop grafana-server
    ignore_errors: true

  - name: 禁用prometheus
    shell: systemctl disable prometheus.service
    ignore_errors: true
  
  - name: 停止 prometheus 服务
    shell: systemctl daemon-reload && systemctl stop prometheus.service
    ignore_errors: true

  - name: 禁用influxdb
    shell: systemctl disable influxdb
    ignore_errors: true
  
  - name: 停止 influxdb 服务
    shell: systemctl daemon-reload && systemctl stop influxdb
    ignore_errors: true

- hosts:
  - localhost
  gather_facts: false

  tasks:
  - name: 获取所有已经创建的POD信息
    tags: always
    command: "{{ bin_dir }}/kubectl get pod -n {{ APP_NAMESPACE }}"
    register: pod_info

  - name: delete linkid
    tags:
    - linkid
    command: "{{ bin_dir }}/kubectl delete -f {{ yaml_dir }}/linkid/"
    when: '"linkid" in pod_info.stdout'

  - name: delete sso
    tags:
    - sso
    command: "{{ bin_dir }}/kubectl delete -f {{ yaml_dir }}/sso/"
    when: '"sso" in pod_info.stdout'

  - name: delete gate
    tags:
    - gate
    command: "{{ bin_dir }}/kubectl delete -f {{ yaml_dir }}/gate/"
    when: '"gate" in pod_info.stdout'

  - name: delete frontend
    tags:
    - frontend
    command: "{{ bin_dir }}/kubectl delete -f {{ yaml_dir }}/frontend/"
    when: '"frontend" in pod_info.stdout'

  - name: delete component
    tags:
    - component
    command: "{{ bin_dir }}/kubectl delete -f {{ yaml_dir }}/component/"
    when: '"component" in pod_info.stdout'

  - name: delete license
    tags:
    - license
    command: "{{ bin_dir }}/kubectl delete -f {{ yaml_dir }}/license/"
    when: '"rg-license" in pod_info.stdout'

  - name: delete faceid-display
    tags:
    - faceid-display
    command: "{{ bin_dir }}/kubectl delete -f {{ yaml_dir }}/faceid-display/"
    when: 'pod_info.stdout is search("rg-faceid-display-[a-z0-9]*-[a-z0-9]*\s")'

  - name: delete faceid
    tags:
    - faceid
    command: "{{ bin_dir }}/kubectl delete -f {{ yaml_dir }}/faceid/"
    when: 'pod_info.stdout is search("rg-faceid-[a-z0-9]*-[a-z0-9]*\s")'

  - name: delete gateway
    tags:
    - gateway
    command: "{{ bin_dir }}/kubectl delete -f {{ yaml_dir }}/gateway/"
    when: '"rg-gateway" in pod_info.stdout'

- hosts:
  - gateway
  roles:
  - { role: ruijie/sourceid/gateway/standalone/clean, tags: ["gateway"] }

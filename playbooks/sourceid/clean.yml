- hosts:
  - localhost
  gather_facts: false

  tasks:
  - name: 获取所有已经创建的POD信息
    tags: always
    command: "kubectl get pod -n {{ APP_NAMESPACE }}"
    register: pod_info

  - name: 停止linkid
    tags:
    - linkid
    command: "kubectl delete -f {{ yaml_dir }}/linkid/"
    when: '"rg-linkid" in pod_info.stdout'

  - name: 停止sso
    tags:
    - sso
    command: "kubectl delete -f {{ yaml_dir }}/sso/"
    when: '"rg-sso" in pod_info.stdout'

  - name: 停止gate
    tags:
    - gate
    command: "kubectl delete -f {{ yaml_dir }}/gate/"
    when: '"gate" in pod_info.stdout'

  - name: 停止frontend
    tags:
    - frontend
    command: "kubectl delete -f {{ yaml_dir }}/frontend/"
    when: '"frontend" in pod_info.stdout'

  - name: 停止 component
    tags:
    - component
    command: "kubectl delete -f {{ yaml_dir }}/component/"
    when: '"component" in pod_info.stdout'

  - name: 停止 license
    tags:
    - license
    command: "kubectl delete -f {{ yaml_dir }}/license/"
    when: '"rg-license" in pod_info.stdout'

  - name: 停止 rg-log
    tags:
    - rg-log
    command: "kubectl delete -f {{ yaml_dir }}/rg-log/"
    when: 'pod_info.stdout is search("rg-log-[a-z0-9]*-[a-z0-9]*\s")'

  - name: 停止 faceid-task
    tags:
    - faceid-task
    command: "kubectl delete -f {{ yaml_dir }}/faceid-task/"
    when: 'pod_info.stdout is search("rg-faceid-task-[a-z0-9]*-[a-z0-9]*\s")'

  - name: 停止 faceid-display
    tags:
    - faceid-display
    command: "kubectl delete -f {{ yaml_dir }}/faceid-display/"
    when: 'pod_info.stdout is search("rg-faceid-display-[a-z0-9]*-[a-z0-9]*\s")'

  - name: 停止 faceid
    tags:
    - faceid
    command: "kubectl delete -f {{ yaml_dir }}/faceid/"
    when: 'pod_info.stdout is search("rg-faceid-[a-z0-9]*-[a-z0-9]*\s")'

  - name: 停止 gateway
    tags:
    - gateway
    command: "kubectl delete -f {{ yaml_dir }}/gateway/"
    when: '"rg-gateway" in pod_info.stdout'

  - name: 停止 import-user
    tags:
    - import-user
    command: "kubectl delete -f {{ yaml_dir }}/import-user/"
    when: '"rg-import-user" in pod_info.stdout'


  - name: 停止 data-sync
    tags:
    - data-sync
    command: "kubectl delete -f {{ yaml_dir }}/data-sync/"
    when: '"rg-data-sync" in pod_info.stdout'

  - name: 停止 security
    tags:
    - security
    command: "kubectl delete -f {{ yaml_dir }}/security/"
    when: '"rg-security" in pod_info.stdout'

  - name: 停止 convert
    tags:
    - convert
    command: "kubectl delete -f {{ yaml_dir }}/convert/"
    when: '"rg-convert" in pod_info.stdout'

  - name: 停止 fgm-backend
    tags:
    - fgm-backend
    command: "kubectl delete -f {{ yaml_dir }}/fgm-backend/"
    when: '"rg-fgm-backend" in pod_info.stdout'

  - name: 停止 groupview
    tags:
      - groupview
    command: "kubectl delete -f {{ yaml_dir }}/groupview/"
    when: 'pod_info.stdout is search("rg-groupview-[a-z0-9]*-[a-z0-9]*\s")'

  - name: 停止 internetid
    tags:
      - internetid
    command: "kubectl delete -f {{ yaml_dir }}/internetid/"
    when: 'pod_info.stdout is search("rg-internetid-[a-z0-9]*-[a-z0-9]*\s")'
    
  - name: 停止 ztsync
    tags:
      - ztsync
    command: "kubectl delete -f {{ yaml_dir }}/ztsync/"
    when: 'pod_info.stdout is search("ztsync-[a-z0-9]*-[a-z0-9]*\s")'

  - name: 停止 collect
    tags:
      - collect
    command: "kubectl delete -f {{ yaml_dir }}/collect/"
    when: 'pod_info.stdout is search("rg-collect-[a-z0-9]*-[a-z0-9]*\s")'

  - name: 停止 adapter
    tags:
      - adapter
    command: "kubectl delete -f {{ yaml_dir }}/adapter/"
    when: 'pod_info.stdout is search("rg-adapter-[a-z0-9]*-[a-z0-9]*\s")'

  - name: 停止 mdm
    tags:
      - mdm
    command: "kubectl delete -f {{ yaml_dir }}/mdm/"
    when: 'pod_info.stdout is search("rg-mdm-[a-z0-9]*-[a-z0-9]*\s")'

  - name: 停止 career-event
    tags:
      - career-event
    command: "kubectl delete -f {{ yaml_dir }}/career-event/"
    when: 'pod_info.stdout is search("rg-career-event-[a-z0-9]*-[a-z0-9]*\s")'

  - name: 停止 xxl-job
    tags:
      - xxl-job
    command: "kubectl delete -f {{ yaml_dir }}/xxl-job/"
    when: 'pod_info.stdout is search("rg-xxl-job-[a-z0-9]*-[a-z0-9]*\s")'

  - name: 停止 rg-flow
    tags:
      - rg-flow
    command: "kubectl delete -f {{ yaml_dir }}/rg-flow/"
    when: 'pod_info.stdout is search("rg-flow-[a-z0-9]*-[a-z0-9]*\s")'

  - name: 停止 portal
    tags:
      - portal
    command: "kubectl delete -f {{ yaml_dir }}/portal/"
    when: 'pod_info.stdout is search("rg-portal-[a-z0-9]*-[a-z0-9]*\s")'

  - name: 停止 report
    tags:
      - report
    command: "kubectl delete -f {{ yaml_dir }}/report/"
    when: 'pod_info.stdout is search("rg-report-[a-z0-9]*-[a-z0-9]*\s")'

  - name: 停止 organization-center
    tags:
      - organization-center
    command: "kubectl delete -f {{ yaml_dir }}/organization-center/"
    when: 'pod_info.stdout is search("rg-organization-center-[a-z0-9]*-[a-z0-9]*\s")'

  - name: 停止 address-book
    tags:
      - address-book
    command: "kubectl delete -f {{ yaml_dir }}/address-book/"
    when: 'pod_info.stdout is search("rg-address-book-[a-z0-9]*-[a-z0-9]*\s")'

  - name: 停止 freeradius
    tags:
      - freeradius
    command: "kubectl delete -f {{ yaml_dir }}/freeradius/"
    when: 'pod_info.stdout is search("rg-freeradius-[a-z0-9]*-[a-z0-9]*\s")'

  - name: 停止 rg-authentication-validate
    tags:
      - rg-authentication-validate
    command: "kubectl delete -f {{ yaml_dir }}/rg-authentication-validate/"
    when: 'pod_info.stdout is search("rg-authentication-validate-[a-z0-9]*-[a-z0-9]*\s")'

  - name: 停止 rocketmq
    tags:
      - rocketmq
    command: "kubectl delete -f {{ yaml_dir }}/rocketmq/"
    when: '"rg-rocket" in pod_info.stdout'

  - name: 等待linkid结束运行
    tags:
    - linkid
    shell: "kubectl get pod -n {{ APP_NAMESPACE }}"
    register: pod_info
    until: '"rg-linkid" not in pod_info.stdout'
    retries: 30
    delay: 3
    ignore_errors: true

  - name: 等待sso结束运行
    tags:
    - sso
    shell: "kubectl get pod -n {{ APP_NAMESPACE }}"
    register: pod_info
    until: 'pod_info.stdout is not search("rg-sso-[a-z0-9]*-[a-z0-9]*\s")'
    retries: 30
    delay: 3
    ignore_errors: true


  - name: 等待gate结束运行
    tags:
    - gate
    shell: "kubectl get pod -n {{ APP_NAMESPACE }}"
    register: pod_info
    until: '"rg-gate" not in pod_info.stdout'
    retries: 30
    delay: 3
    ignore_errors: true


  - name: 等待frontend结束运行
    tags:
    - frontend
    shell: "kubectl get pod -n {{ APP_NAMESPACE }}"
    register: pod_info
    until: '"rg-frontend" not in pod_info.stdout'
    retries: 30
    delay: 3
    ignore_errors: true

  - name: 等待component结束运行
    tags:
    - component
    shell: "kubectl get pod -n {{ APP_NAMESPACE }}"
    register: pod_info
    until: '"rg-component" not in pod_info.stdout'
    retries: 30
    delay: 3
    ignore_errors: true

  - name: 等待license结束运行
    tags:
    - license
    shell: "kubectl get pod -n {{ APP_NAMESPACE }}"
    register: pod_info
    until: '"rg-license" not in pod_info.stdout'
    retries: 30
    delay: 3
    ignore_errors: true

  - name: 等待rg-log结束运行
    tags:
    - rg-log
    shell: "kubectl get pod -n {{ APP_NAMESPACE }}"
    register: pod_info
    until: '"rg-log" not in pod_info.stdout'
    retries: 30
    delay: 3
    ignore_errors: true

  - name: 等待faceid-task结束运行
    tags:
    - faceid-task
    shell: "kubectl get pod -n {{ APP_NAMESPACE }}"
    register: pod_info
    until: '"rg-faceid-task" not in pod_info.stdout'
    retries: 30
    delay: 3
    ignore_errors: true

  - name: 等待faceid-display结束运行
    tags:
    - faceid-display
    shell: "kubectl get pod -n {{ APP_NAMESPACE }}"
    register: pod_info
    until: '"rg-faceid-display" not in pod_info.stdout'
    retries: 30
    delay: 3
    ignore_errors: true


  - name: 等待faceid结束运行
    tags:
    - faceid
    shell: "kubectl get pod -n {{ APP_NAMESPACE }}"
    register: pod_info
    until: 'pod_info.stdout is not search("rg-faceid-[a-z0-9]*-[a-z0-9]*\s")'
    retries: 30
    delay: 3
    ignore_errors: true


  - name: 等待gateway结束运行
    tags:
    - gateway
    shell: "kubectl get pod -n {{ APP_NAMESPACE }}"
    register: pod_info
    until: '"rg-gateway" not in pod_info.stdout'
    retries: 30
    delay: 3
    ignore_errors: true

  - name: 等待import-user结束运行
    tags:
    - import-user
    shell: "kubectl get pod -n {{ APP_NAMESPACE }}"
    register: pod_info
    until: '"rg-import-user" not in pod_info.stdout'
    retries: 30
    delay: 3
    ignore_errors: true


  - name: 等待data-sync结束运行
    tags:
    - data-sync
    shell: "kubectl get pod -n {{ APP_NAMESPACE }}"
    register: pod_info
    until: '"rg-data-sync" not in pod_info.stdout'
    retries: 30
    delay: 3
    ignore_errors: true
    
  - name: 等待security结束运行
    tags:
    - security
    shell: "kubectl get pod -n {{ APP_NAMESPACE }}"
    register: pod_info
    until: '"rg-security" not in pod_info.stdout'
    retries: 30
    delay: 3
    ignore_errors: true
    
  - name: 等待convert结束运行
    tags:
    - convert
    shell: "kubectl get pod -n {{ APP_NAMESPACE }}"
    register: pod_info
    until: '"rg-convert" not in pod_info.stdout'
    retries: 30
    delay: 3
    ignore_errors: true

  - name: 等待convert结束运行
    tags:
    - fgm-backend
    shell: "kubectl get pod -n {{ APP_NAMESPACE }}"
    register: pod_info
    until: '"rg-fgm-backend" not in pod_info.stdout'
    retries: 30
    delay: 3
    ignore_errors: true

  - name: 等待groupview结束运行
    tags:
      - groupview
    shell: "kubectl get pod -n {{ APP_NAMESPACE }}"
    register: pod_info
    until: '"rg-groupview" not in pod_info.stdout'
    retries: 30
    delay: 3
    ignore_errors: true

  - name: 等待internetid结束运行
    tags:
      - internetid
    shell: "kubectl get pod -n {{ APP_NAMESPACE }}"
    register: pod_info
    until: '"rg-internetid" not in pod_info.stdout'
    retries: 30
    delay: 3
    ignore_errors: true

  - name: 等待ztsync结束运行
    tags:
      - ztsync
    shell: "kubectl get pod -n {{ APP_NAMESPACE }}"
    register: pod_info
    until: '"rg-ztsync" not in pod_info.stdout'
    retries: 30
    delay: 3
    ignore_errors: true

  - name: 等待collect结束运行
    tags:
      - collect
    shell: "kubectl get pod -n {{ APP_NAMESPACE }}"
    register: pod_info
    until: '"rg-collect" not in pod_info.stdout'
    retries: 30
    delay: 3
    ignore_errors: true

  - name: 等待adapter结束运行
    tags:
      - adapter
    shell: "kubectl get pod -n {{ APP_NAMESPACE }}"
    register: pod_info
    until: '"rg-adapter" not in pod_info.stdout'
    retries: 30
    delay: 3
    ignore_errors: true

  - name: 等待mdm结束运行
    tags:
      - mdm
    shell: "kubectl get pod -n {{ APP_NAMESPACE }}"
    register: pod_info
    until: '"rg-mdm" not in pod_info.stdout'
    retries: 30
    delay: 3
    ignore_errors: true

  - name: 等待career-event结束运行
    tags:
      - career-event
    shell: "kubectl get pod -n {{ APP_NAMESPACE }}"
    register: pod_info
    until: '"rg-career-event" not in pod_info.stdout'
    retries: 30
    delay: 3
    ignore_errors: true

  - name: 等待xxl-job结束运行
    tags:
      - xxl-job
    shell: "kubectl get pod -n {{ APP_NAMESPACE }}"
    register: pod_info
    until: 'pod_info.stdout is not search("rg-xxl-job-[a-z0-9]*-[a-z0-9]*\s")'
    retries: 30
    delay: 3
    ignore_errors: true

  - name: 等待rg-flow结束运行
    tags:
      - rg-flow
    shell: "kubectl get pod -n {{ APP_NAMESPACE }}"
    register: pod_info
    until: 'pod_info.stdout is not search("rg-flow-[a-z0-9]*-[a-z0-9]*\s")'
    retries: 30
    delay: 3
    ignore_errors: true

  - name: 等待portal结束运行
    tags:
      - portal
    shell: "kubectl get pod -n {{ APP_NAMESPACE }}"
    register: pod_info
    until: 'pod_info.stdout is not search("rg-portal-[a-z0-9]*-[a-z0-9]*\s")'
    retries: 30
    delay: 3
    ignore_errors: true

  - name: 等待report结束运行
    tags:
      - report
    shell: "kubectl get pod -n {{ APP_NAMESPACE }}"
    register: pod_info
    until: 'pod_info.stdout is not search("rg-report-[a-z0-9]*-[a-z0-9]*\s")'
    retries: 30
    delay: 3
    ignore_errors: true

  - name: 等待organization-center结束运行
    tags:
      - organization-center
    shell: "kubectl get pod -n {{ APP_NAMESPACE }}"
    register: pod_info
    until: 'pod_info.stdout is not search("rg-organization-center-[a-z0-9]*-[a-z0-9]*\s")'
    retries: 30
    delay: 3
    ignore_errors: true

  - name: 等待address-book结束运行
    tags:
      - address-book
    shell: "kubectl get pod -n {{ APP_NAMESPACE }}"
    register: pod_info
    until: 'pod_info.stdout is not search("rg-address-book-[a-z0-9]*-[a-z0-9]*\s")'
    retries: 30
    delay: 3
    ignore_errors: true

  - name: 等待freeradius结束运行
    tags:
      - freeradius
    shell: "kubectl get pod -n {{ APP_NAMESPACE }}"
    register: pod_info
    until: 'pod_info.stdout is not search("rg-freeradius-[a-z0-9]*-[a-z0-9]*\s")'
    retries: 30
    delay: 3
    ignore_errors: true

  - name: 等待rg-authentication-validate结束运行
    tags:
      - rg-authentication-validate
    shell: "kubectl get pod -n {{ APP_NAMESPACE }}"
    register: pod_info
    until: 'pod_info.stdout is not search("rg-authentication-validate-[a-z0-9]*-[a-z0-9]*\s")'
    retries: 30
    delay: 3
    ignore_errors: true

  - name: 等待rocketmq结束运行
    tags:
      - rocketmq
    shell: "kubectl get pod -n {{ APP_NAMESPACE }}"
    register: pod_info
    until: '"rg-rocket" not in pod_info.stdout'
    retries: 30
    delay: 3
    ignore_errors: true

- hosts:
  - gateway
  roles:
  - { role: ruijie/sourceid/gateway/standalone/clean, tags: ["gateway"] }

- import_playbook: env-check.yml
- hosts:
  - kube_node
  tags:
  - initdata
  any_errors_fatal: true
  vars_files:
  - "{{ KAD_PACKAGE_DIR }}/kad.yml"
  - "/etc/kad/config.yml"
  roles:
  - { role: ruijie/sourceid/hotfix-dbupdate, tags: always }
  - { role: ruijie/sourceid/prepare-db-pwd, tags: always }
  - { role: ruijie/sourceid/dbinit, tags: always }


- hosts:
  - localhost
  gather_facts: false

  tasks:
  - name: 获取所有已经创建的POD信息
    tags: always
    command: "kubectl get pod -n {{ APP_NAMESPACE }}"
    register: pod_info

  - name: 停止 freeradius
    tags:
    - freeradius
    command: "kubectl delete -f {{ yaml_dir }}/freeradius/"
    when: 'pod_info.stdout is search("rg-freeradius-[a-z0-9]*-[a-z0-9]*\s")'

  - name: 停止 rg-authentication-validate
    tags:
    - rg-authentication-validate
    command: "kubectl delete -f {{ yaml_dir }}/rg-authentication-validate/"
    when: 'pod_info.stdout is search("rg-authentication-validate-[a-z0-9]*-[a-z0-9]*\s")'  

  - name: 等待freeradius结束运行
    tags:
    - freeradius
    shell: "kubectl get pod -n {{ APP_NAMESPACE }}"
    register: pod_info
    until: 'pod_info.stdout is not search("rg-freeradius-[a-z0-9]*-[a-z0-9]*\s")'
    retries: 30
    delay: 3
    ignore_errors: true

  - name: 等待rg-authentication-validate结束运行
    tags:
    - rg-authentication-validate
    shell: "kubectl get pod -n {{ APP_NAMESPACE }}"
    register: pod_info
    until: 'pod_info.stdout is not search("rg-authentication-validate-[a-z0-9]*-[a-z0-9]*\s")'
    retries: 30
    delay: 3
    ignore_errors: true

- import_playbook: update-pod.yml
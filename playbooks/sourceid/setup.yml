- hosts:
  - kube_node
  tags: always
  any_errors_fatal: true
  roles:
  - ruijie/sourceid/env

- hosts:
  - change-domain
  tags:
  - change-domain
  - midware
  vars_files:
  - "/etc/kad/config.yml"
  any_errors_fatal: true
  roles:
  - { role: ruijie/sourceid/change-domain}

- hosts:
  - mongodb
  tags:
  - mongodb
  - midware
  vars_files:
  - "/etc/kad/config.yml"
  any_errors_fatal: true
  roles:
  - { role: ruijie/mongo}

- hosts:
  - rocketmq
  tags:
  - rocketmq
  - midware
  vars_files:
  - "/etc/kad/config.yml"
  any_errors_fatal: true
  roles:
  - { role: ruijie/rocketmq}

- hosts:
  - pgsql
  tags:
  - pgsql
  - midware
  - sourceid-universities
  vars_files:
  - "{{ KAD_PACKAGE_DIR }}/kad.yml"
  - "/etc/kad/config.yml"
  any_errors_fatal: true
  roles:
  - { role: ruijie/pgsql}

- hosts:
  - kube_node
  tags:
  - initdata
  any_errors_fatal: true
  vars_files:
  - "{{ KAD_PACKAGE_DIR }}/kad.yml"
  - "/etc/kad/config.yml"
  roles:
  - { role: ruijie/sourceid/prepare-db-pwd, tags: always }
  - { role: ruijie/sourceid/dbinit, tags: always }
  
- import_playbook: apply.yml

- hosts:
  - gateway
  tags:
  - sourceid
  any_errors_fatal: true
  vars_files:
  - "{{ KAD_PACKAGE_DIR }}/kad.yml"
  - "/etc/kad/config.yml"
  roles:
  - ruijie/cluster/docker
  - { role: ruijie/sourceid/prepare-db-pwd, tags: always }
  - { role: ruijie/sourceid/gateway/common, tags: ["gateway"] }
  - { role: ruijie/sourceid/gateway/standalone/setup, tags: ["gateway"] }

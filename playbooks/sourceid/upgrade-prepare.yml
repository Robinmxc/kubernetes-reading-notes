- hosts:
  - localhost
  tasks:
  - name: 创建/etc/kad目录
    file: path="/etc/kad/" state=directory

  - name: 创建/etc/kad/config.yml文件
    file: path="/etc/kad/config.yml" state=touch

  - name: 获取所有已经创建的POD信息
    tags: always
    command: "{{ bin_dir }}/kubectl get pod -n kube-system"
    register: pod_info
    
  - name: 停止coredns组件
    command: "{{ bin_dir }}/kubectl delete -f /opt/kube/kube-system/{{ dns_backend }}"
    when: '"coredns" in pod_info.stdout'

  - name: 等待coredns结束运行
    shell: "{{ bin_dir }}/kubectl get pod -n kube-system"
    register: pod_info
    until: '"coredns" not in pod_info.stdout'
    retries: 30
    delay: 3
    ignore_errors: true

# to install clust-addons
- hosts:
  - kube_node
  any_errors_fatal: true
  roles:
  - ruijie/cluster/kube-dns

- hosts: all
  tags:
  - sourceid
  any_errors_fatal: true
  vars_files:
  - "{{ KAD_PACKAGE_DIR }}/kad.yml"
  - "/etc/kad/config.yml"
  roles:
  - { role: ruijie/sourceid/prepare-db-pwd, tags: always }
  - { role: ruijie/sourceid/upgrade, tags: always }
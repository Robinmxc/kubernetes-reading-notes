- hosts:
  - localhost
  tasks:
  - name: 创建/etc/kad目录
    file: path="/etc/kad/" state=directory

  - name: 创建/etc/kad/config.yml文件
    file: path="/etc/kad/config.yml" state=touch

- hosts: all
  tags:
  - sourceid
  any_errors_fatal: true
  vars_files:
  - "{{ KAD_PACKAGE_DIR }}/kad.yml"
  - "/etc/kad/config.yml"
  roles:
  - { role: ruijie/sourceid/prepare-db-pwd, tags: always }
  - { role: ruijie/sourceid/upgrade, tags: always }


- hosts: all
  tasks:
  - name: 获取当前k8s版本
    shell: "kubectl version --short"
    register: k8s_result
    connection: local
    ignore_errors: true
    run_once: true

- name: 清理k8s
  when: '"{{ kubernetes_version }}" not in k8s_result.stdout'
  import_playbook: ../cluster/k8s-clean.yml

- name: 安装k8s
  when: '"{{ kubernetes_version }}" not in k8s_result.stdout'
  import_playbook: ../cluster/k8s-setup.yml
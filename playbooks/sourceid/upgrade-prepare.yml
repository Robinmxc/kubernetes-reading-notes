- hosts:
  - localhost
  tasks:
  - name: 创建/etc/kad目录
    file: path="/etc/kad/" state=directory

  - name: 创建/etc/kad/config.yml文件
    file: path="/etc/kad/config.yml" state=touch

- hosts: all
  tags:
  - sourceid
  any_errors_fatal: true
  vars_files:
  - "{{ KAD_PACKAGE_DIR }}/kad.yml"
  - "/etc/kad/config.yml"
  roles:
  - { role: ruijie/sourceid/prepare-db-pwd, tags: always }
  - { role: ruijie/sourceid/upgrade, tags: always }

- hosts:
  - all
  tasks:
  - name: 获取当前ingress实现
    shell: "{{ bin_dir }}/kubectl -n kube-system get pod"
    register: ingress_result
    connection: local
    ignore_errors: true
    run_once: true

  - name: 获取traefik名称
    shell: "{{ bin_dir }}/kubectl -n kube-system get daemonsets.apps -o custom-columns=NAME:.metadata.name|grep traefik"
    register: traefik_result
    connection: local
    ignore_errors: true
    run_once: true
    when: '"traefik" in ingress_result.stdout'

  - name: 停止traefik
    shell: "{{ bin_dir }}/kubectl delete daemonset -n kube-system {{ traefik_result.stdout }} "
    connection: local
    ignore_errors: true
    run_once: true
    when: '"traefik" in ingress_result.stdout'

- name: 启动ingress
  when: '"traefik" in ingress_result.stdout'
  import_playbook: ../cluster/ingress.yml

- hosts: all
  tasks:
  - name: 获取当前k8s版本
    shell: "kubectl version --short"
    register: k8s_result
    connection: local
    ignore_errors: true
    run_once: true

- name: 清理k8s
  when: '"v1.18.8" not in k8s_result.stdout'
  import_playbook: ../cluster/k8s-clean.yml

- name: 安装k8s
  when: '"v1.18.8" not in k8s_result.stdout'
  import_playbook: ../cluster/k8s-setup.yml

- hosts: localhost
  tasks: 
  - name: 输出mongo备份路径
    debug:
      msg: "{{ DATA_DIR }}/ruijie/{{ APP_NAMESPACE }}/upgrade_temp/mongodbbak"
- hosts:
    - localhost
  tasks:
    - name: 环境检测
      fail:
        msg: "escape-vip只支持通过smp+本体部署"
      when: "APP_NAMESPACE == 'ruijie-escape'"

- hosts:
  - escape_node
  vars_files:
    - "/etc/kad/config.yml"
  tasks:
    - name: 清理escape keepalived配置
      file: name="{{ item }}"
      state: absent
      with_items:
        /etc/keepalived/conf/keepalived_escape.conf
        /etc/keepalived/conf/master_escape_check.sh
        /etc/keepalived/conf/backup_escape_check.sh

    - name: 检查keepalived配置
      shell: "ls -A /etc/keepalived/conf | grep .conf"
      register: conf_info

    - name: 停止keepalived服务
      when: "{{conf_info.stdout }} == ''"
      service: name=keepalived state=stopped enabled=no

    - name: 重新配置keepalived服务
      when: "{{conf_info.stdout }} != ''"
      shell: systemctl reload keepalived
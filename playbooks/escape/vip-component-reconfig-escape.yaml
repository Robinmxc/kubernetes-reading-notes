- hosts: all
  any_errors_fatal: true

- hosts:
    - escape
  gather_facts: false
  tasks:
    # 从逃生部署的时候，需要通过本机替换配置执行后续操作，目前缺少对smp+执行填充数据reconfig的操作
    - name: 替换escape的配置文件变量
      when: "APP_NAMESPACE == 'ruijie-escape' and ESCAPE_FIRST"
      tags: always
      replace: path="/opt/kad/workspace/ruijie-escape/conf/all.yml" regexp="{{ item.regexp }}" replace="{{ item.replace }}"
      with_items:
        - {regexp: "ESCAPE_SYNC_VIP.*$", replace: "ESCAPE_SYNC_VIP: \"{{ ESCAPE.VIP }}\""}
        - {regexp: "SMPPLUS_VIP.*$", replace: "SMPPLUS_VIP: \"{{ SMP_NEW_IP }}\""}
        - {regexp: "SESSION_TIMEOUT.*$", replace: "SESSION_TIMEOUT: {{ ESCAPE.SESSION_TIMEOUT }}"}

    #从smp+本机执行逃生部署，需要替换逃生服务器的配置后续操作
    - name: 替换escape的配置文件变量
      when: "APP_NAMESPACE == 'ruijie-smpplus'"
      tags: always
      replace: path="/opt/kad/workspace/ruijie-escape/conf/all.yml" regexp="{{ item.regexp }}" replace="{{ item.replace }}"
      with_items:
        - {regexp: "ESCAPE_SYNC_VIP.*$", replace: "ESCAPE_SYNC_VIP: \"{{ ESCAPE.VIP }}\""}
        - {regexp: "SMPPLUS_VIP.*$", replace: "SMPPLUS_VIP: \"{{ KUBE_MASTER_VIP }}\""}
        - {regexp: "SESSION_TIMEOUT.*$", replace: "SESSION_TIMEOUT: {{ ESCAPE.SESSION_TIMEOUT }}"}

    - name: 获取所有已经创建的POD信息
      tags:
        - ingress
      command: "kubectl get pod -n kube-system"
      register: pod_info

    - name: 远程清理ingress
      tags:
        - ingress
      command: "kubectl delete -f /opt/kube/kube-system/nginx-ingress/"
      when: '"nginx-ingress"  in pod_info.stdout'

    - name: 等待ingress结束运行
      tags:
        - ingress
      shell: "kubectl get pod -n kube-system"
      register: pod_info
      until: '"nginx-ingress" not in pod_info.stdout'
      retries: 30
      delay: 3
      ignore_errors: true

    - name: 远程重新配置ingress，请耐心等待
      tags:
        - ingress
      shell: 'export KAD_APP_NAMESPACE=ruijie-escape; \
            cd /opt/kad; \
            export ssh_password={{ ansible_sudo_pass }}; \
            export serverUser={{ ansible_sudo_user }}; \
            ./kad-play.sh playbooks/cluster/ingress.yml'

    - name: 远程执行escape的部署更新，请耐心等待
      tags:
        - ingress
      shell: 'export KAD_APP_NAMESPACE=ruijie-escape; \
            cd /opt/kad; \
            export ssh_password={{ ansible_sudo_pass }}; \
            export serverUser={{ ansible_sudo_user }}; \
            ./kad-play.sh playbooks/escape/reconfig.yml'
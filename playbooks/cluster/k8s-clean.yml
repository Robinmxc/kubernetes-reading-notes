# WARNING: This playbook will erase the entire k8s-cluster, include PODs, ETCD data etc.
# Make sure you know what you are doing.

- hosts:
    - kube_master
    - kube_node
  tasks:
  - name: 获取maintenance-related script
    tags:
      - maintenance-related
    shell: "grep 'smpplus-oper.sh'  /var/spool/cron/root | cat"
    register: maintenance_script_status
    when: 'KAD_APP_NAME == "smpplus"'
    ignore_errors: true

  - name: delete maintenance-related
    tags:
      - maintenance-related
    shell: "sed -i '/{{ item }}/d' /var/spool/cron/root"
    with_items:
      - "smpplus-oper.sh"
    when: 'KAD_APP_NAME == "smpplus" and "smpplus-oper.sh" in maintenance_script_status.stdout'
    ignore_errors: true


# to clean 'kube_node' nodes
- hosts:
  - kube_master
  - kube_node
  tasks:
  - name: stop and disable kube_node service
    service: name={{ item }} state=stopped enabled=no
    with_items:
    - kubelet
    ignore_errors: true
    no_log: true

  - name: umount kubelet filesystems
    shell: "mount | grep '/var/lib/kubelet'| awk '{print $3}'|xargs umount"
    args:
      warn: false    
    ignore_errors: true


  - name: 查看是否安装docker
    shell: "systemctl status docker.service  2>&1|grep Active|cat"
    register: docker_status_first
    ignore_errors: true
    no_log: true

  - name: 重启docker 服务
    shell: systemctl restart docker
    when: '"running" in docker_status_first.stdout'
    ignore_errors: true
    no_log: true

  - name: 轮询等待docker服务重启完毕
    shell: "systemctl status docker.service  2>&1|grep Active|cat"
    register: docker_status
    until: '"running" in docker_status.stdout'
    when: '"running" in docker_status_first.stdout'    
    retries: 8
    delay: 2
    ignore_errors: true
    no_log: true

  - name: reset kubeadm
    shell: 'kubeadm reset -f 2>&1|cat'
    ignore_errors: true
    no_log: true

  - name: cleanup iptables
    shell: "iptables -F && iptables -X \
	&& iptables -F -t nat && iptables -X -t nat \
	&& iptables -F -t raw && iptables -X -t raw \
	&& iptables -F -t mangle && iptables -X -t mangle"
    #when: "'kubeasz' not in install_info.stdout"

  - name: 查询网卡信息
    shell: "ip link | grep mtu"
    register: ip_link_info

  - name: cleanup networks1
    shell: "ip link del {{ item }}"
    when: 'item in ip_link_info.stdout'
    with_items:
      - "tunl0"
      - "flannel.1"
      - "cni0"
      - "mynet0"
      - "kube-bridge"
      - "dummy0"
      - "cilium_net"
      - "cilium_vxlan"
      - "kube-ipvs0"
    ignore_errors: true

  - name: cleanup 'calico' routes
    shell: "for rt in `ip route|grep bird|sed 's/blackhole//'|awk '{print $1}'`;do ip route del $rt;done;"
    when: "CLUSTER_NETWORK == 'calico'"
    ignore_errors: true

# to clean 'lb' nodes
- hosts:
  - lb
  - ex-lb
  tasks:
  - name: stop keepalived service
    shell: systemctl disable keepalived && systemctl stop keepalived
    ignore_errors: true

  - name: stop haproxy service
    shell: systemctl disable haproxy && systemctl stop haproxy
    ignore_errors: true

  - name: remove files and dirs
    file: name={{ item }} state=absent
    with_items:
    - "/etc/haproxy"
    - "/etc/keepalived"
    - "/var/lib/etcd"
    

# to clean ntp, certs and keys, env path
- hosts:
  - kube_master
  - kube_node
  - deploy
  - etcd
  - lb
  tasks:
  - name: stop and disable chrony in Ubuntu
    service: name=chrony state=stopped enabled=no
    ignore_errors: true
    tags: rm_ntp 
    when: ansible_distribution == "Ubuntu" or ansible_distribution == "Debian"

  - name: 查询chronyd状态
    shell: "systemctl list-units *.service"
    register: svc_info
    when: ansible_distribution == "CentOS" or ansible_distribution == "RedHat" or "UOS"  in  ansible_distribution  or "Anolis"  in  ansible_distribution or "openEuler"  in  ansible_distribution or "Kylin"  in  ansible_distribution

  - name: stop and disable chronyd in CentOS/RedHat/Anolis/openEuler
    service: name=chronyd state=stopped enabled=no
    tags: rm_ntp
    when: '"chronyd" in svc_info.stdout'
    ignore_errors: true

  - name: clean certs and keys
    file: name={{ item }} state=absent
    with_items:
    - "/etc/kubernetes/"
    - "{{ ca_dir }}" 
    - "/root/.kube/config"
    - "/var/lib/etcd"

  - name: clean 'ENV PATH'
    lineinfile:
      dest: ~/.bashrc
      state: absent
      regexp: '{{ item }}'
    with_items:
    #- 'kubeasz'
    - 'helm'
    - 'kubectl completion'
    - 'HELM_TLS_ENABLE'

#clean kadapi service
- hosts:
    - kube_master
  tasks:
  - name: stop and disable kadapi service
    service: name={{ item }} state=stopped enabled=no
    when: 'KAD_APP_NAME == "smpplus" and iswebchangeip is undefined'
    with_items:
      - kadapi
    ignore_errors: true

  - name: remove files and dirs of 'kadapi' nodes
    file: name={{ item }} state=absent
    with_items:
      - "/etc/systemd/system/kadapi.service"
    ignore_errors: true
    when: 'KAD_APP_NAME == "smpplus" and iswebchangeip is undefined'

  - name: stop and disable autostart service
    shell: "systemctl disable autostart.sh && systemctl stop autostart"
    ignore_errors: true
  - name: remove autostart service files and dirs2
    file: name={{ item }} state=absent
    with_items:
      - "/etc/init.d/autostart.sh"
# to synchronize time of nodes with 'chrony'
- hosts: all
  any_errors_fatal: true
  roles:
  - ruijie/cluster/chrony

# to create CA, kubeconfig, kube-proxy.kubeconfig etc. on 'deploy' node
#- hosts: deploy
#  any_errors_fatal: true
#  roles:
#  - deploy

- hosts:
    - kube_master
    - kube_node
  tasks:
  - name: 获取maintenance-related script
    tags:
      - maintenance-related
    shell: "grep 'smpplus-oper.sh'  /var/spool/cron/root | cat"
    register: maintenance_script_status
    when: 'KAD_APP_NAME == "smpplus"'
    ignore_errors: true

  - name: delete maintenance-related
    tags:
      - maintenance-related
    shell: "sed -i '/{{ item }}/d' /var/spool/cron/root"
    with_items:
      - "smpplus-oper.sh"
    when: 'KAD_APP_NAME == "smpplus" and "smpplus-oper.sh" in maintenance_script_status.stdout'
    ignore_errors: true


# prepare tasks for all nodes
- hosts:
  - kube_master
  - kube_node
  - deploy
  - etcd
  - lb
  any_errors_fatal: true
  roles:
  - ruijie/cluster/prepare


# to install etcd cluster
#- hosts: etcd
#  any_errors_fatal: true
#  roles:
#  - etcd

# to install docker service
- hosts:
  - kube_master
  - kube_node
  any_errors_fatal: true
  roles:
  - ruijie/cluster/docker

  tasks:
  - name: 检查syslog是否存在
    stat:
      path: /etc/logrotate.d/syslog
    register: syslog_status

  - name: 查询系统日志自动滚动机制
    shell: "cat /etc/logrotate.d/syslog"
    register: syslog_info
    ignore_errors: true
    when: syslog_status.stat.exists  

  - name: 设置系统日志自动滚动机制
    shell: "sed -i '/{/a \\\\n    rotate 10\\n    size 100M\\n    dateext\\n    daily' /etc/logrotate.d/syslog"
    when: syslog_status.stat.exists and "'dateext' not in syslog_info.stdout"
    ignore_errors: true

  - name: 检查rsyslog是否存在
    stat:
      path: /etc/logrotate.d/rsyslog
    register: rsyslog_status

  - name: 查询系统日志自动滚动机制
    shell: "cat /etc/logrotate.d/rsyslog"
    register:  rsyslog_info
    ignore_errors: true
    when: rsyslog_status.stat.exists  

  - name: 设置系统日志自动滚动机制
    shell: "sed -i '/{/a \\\\n    rotate 10\\n    size 100M\\n    dateext\\n    daily' /etc/logrotate.d/rsyslog"
    when: rsyslog_status.stat.exists and "'dateext' not in rsyslog_info.stdout"
    ignore_errors: true


    
# to set up 'kube_master' nodes
- hosts: kube_master
  any_errors_fatal: true
  roles:
  - ruijie/cluster/keepalived  
  - kube-master
  #- kube-node
  #
  #tasks:
  #- name: Making master nodes SchedulingDisabled
  #  shell: "kubectl cordon {{ inventory_hostname }} "
  #  delegate_to: "{{ groups.deploy[0] }}"
  #  when: DEPLOY_MODE != "allinone"
  #  ignore_errors: true

  #- name: Setting master role name
  #  shell: "kubectl label node {{ inventory_hostname }} kubernetes.io/role=master --overwrite"
  #  ignore_errors: true
  #  delegate_to: "{{ groups.deploy[0] }}"

# to install flannel
- hosts: 
  - kube_master
  - kube_node
  any_errors_fatal: true
  roles:
  - ruijie/cluster/flannel
# to set up 'kube_node' nodes
- hosts: kube_node
  any_errors_fatal: true
  roles:
  - kube-node

- hosts: 
  - kube_master
  - kube_node
  any_errors_fatal: true
  roles:
  - kube-process
# to install network plugin, only one can be choosen
#- hosts:
#  - kube_master
#  - kube_node
#  any_errors_fatal: true
#  roles:
#  - ruijie/cluster/flannel

# to install clust-addons
#- hosts:
#  - kube_node
#  any_errors_fatal: true
#  roles:
#  - ruijie/cluster/kube-dns
#  - ruijie/cluster/ingress

# to install ingress

- hosts: kube_node
  tasks:
  - name: 重启coreDns,触发CoreDns漂移
    shell: "kubectl delete pod -l k8s-app=kube-dns -n kube-system"
    connection: local
    run_once: true
    tags: upgrade_k8s
  
- hosts: kube_node
  any_errors_fatal: true
  roles:
  - ruijie/cluster/ingress

- hosts: kube_master
  tasks:
  - name: k8s安装完毕后，keepalive开启业务检测
    shell: "sed -i 's/is_enabled_check=false/is_enabled_check=true/' /etc/keepalived/conf/check_k8s.sh"
    when: '"" != KUBE_MASTER_VIP and DEPLOY_MODE == "multi-master" '

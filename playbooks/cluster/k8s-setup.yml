# to synchronize time of nodes with 'chrony'
- hosts: all
  any_errors_fatal: true
  roles:
  - ruijie/chrony

# to create CA, kubeconfig, kube-proxy.kubeconfig etc. on 'deploy' node
- hosts: deploy
  any_errors_fatal: true
  roles:
  - deploy

# prepare tasks for all nodes
- hosts:
  - kube-master
  - kube-node
  - deploy
  - etcd
  - lb
  any_errors_fatal: true
  roles:
  - ruijie/prepare

# [optional] to install loadbalance service, only needed by multi-master cluster
- hosts: lb
  any_errors_fatal: true
  roles:
  - lb

# to install etcd cluster
- hosts: etcd
  any_errors_fatal: true
  roles:
  - etcd

# to install docker service
- hosts:
  - kube-master
  - kube-node
  any_errors_fatal: true
  roles:
  - ruijie/docker

# to set up 'kube-master' nodes
- hosts: kube-master
  any_errors_fatal: true
  roles:
  - kube-master
  - kube-node
  #
  tasks:
  - name: Making master nodes SchedulingDisabled
    shell: "{{ bin_dir }}/kubectl cordon {{ inventory_hostname }} "
    delegate_to: "{{ groups.deploy[0] }}"
    when: DEPLOY_MODE != "allinone"
    ignore_errors: true

  - name: Setting master role name
    shell: "{{ bin_dir }}/kubectl label node {{ inventory_hostname }} kubernetes.io/role=master --overwrite"
    ignore_errors: true
    delegate_to: "{{ groups.deploy[0] }}"

# to set up 'kube-node' nodes
- hosts: kube-node
  any_errors_fatal: true
  roles:
  - { role: kube-node, when: "DEPLOY_MODE != 'allinone'" }

# to install network plugin, only one can be choosen
- hosts:
  - kube-master
  - kube-node
  any_errors_fatal: true
  roles:
  - ruijie/flannel

# to install clust-addons
- hosts:
  - kube-node
  any_errors_fatal: true
  roles:
  - ruijie/kube-dns
  - ruijie/ingress
  - ruijie/dashboard
  - ruijie/metrics-server

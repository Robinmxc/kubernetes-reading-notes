# to synchronize time of nodes with 'chrony'
- hosts: all
  any_errors_fatal: true
  roles:
  - ruijie/cluster/chrony

# to create CA, kubeconfig, kube-proxy.kubeconfig etc. on 'deploy' node
#- hosts: deploy
#  any_errors_fatal: true
#  roles:
#  - deploy

- hosts:
    - kube_master
    - kube_node
  tasks:
  - name: 获取maintenance-related script
    tags:
      - maintenance-related
    shell: "grep 'smpplus-oper.sh'  /var/spool/cron/root | cat"
    register: maintenance_script_status
    when: 'KAD_APP_NAME == "smpplus"'
    ignore_errors: true

  - name: delete maintenance-related
    tags:
      - maintenance-related
    shell: "sed -i '/{{ item }}/d' /var/spool/cron/root"
    with_items:
      - "smpplus-oper.sh"
    when: 'KAD_APP_NAME == "smpplus" and "smpplus-oper.sh" in maintenance_script_status.stdout'
    ignore_errors: true


# prepare tasks for all nodes
- hosts:
  - kube_master
  - kube_node
  - deploy
  - etcd
  - lb
  any_errors_fatal: true
  roles:
  - ruijie/cluster/prepare


# to install etcd cluster
#- hosts: etcd
#  any_errors_fatal: true
#  roles:
#  - etcd

# to install docker service
- hosts:
  - kube_master
  - kube_node
  any_errors_fatal: true
  roles:
  - ruijie/cluster/docker

  tasks:
  - name: 查询系统日志自动滚动机制
    shell: "cat /etc/logrotate.d/syslog"
    register: syslog_info
    ignore_errors: true
    when: ("Anolis"  in  ansible_distribution and ansible_distribution_major_version == "8")

  - name: 设置系统日志自动滚动机制
    shell: "sed -i '/{/a \\\\n    rotate 10\\n    size 100M\\n    dateext\\n    daily' /etc/logrotate.d/syslog"
    when: ("'dateext' not in syslog_info.stdout" and "Anolis"  in  ansible_distribution and ansible_distribution_major_version == "8")
    ignore_errors: true

  - name: 查询系统日志自动滚动机制
    shell: "cat /etc/logrotate.d/rsyslog"
    register: syslog_info
    ignore_errors: true
    when: ("openEuler"  in  ansible_distribution and ansible_distribution_major_version == "22")  

  - name: 设置系统日志自动滚动机制
    shell: "sed -i '/{/a \\\\n    rotate 10\\n    size 100M\\n    dateext\\n    daily' /etc/logrotate.d/rsyslog"
    when: ("'dateext' not in syslog_info.stdout" and "openEuler"  in  ansible_distribution and ansible_distribution_major_version == "22")
    ignore_errors: true

  - name: 查询系统日志自动滚动机制
    shell: "cat /etc/logrotate.d/rsyslog"
    register: syslog_info
    ignore_errors: true
    when: ("Kylin"  in  ansible_distribution )  

  - name: 设置系统日志自动滚动机制
    shell: "sed -i '/{/a \\\\n    rotate 10\\n    size 100M\\n    dateext\\n    daily' /etc/logrotate.d/rsyslog"
    when: ("'dateext' not in syslog_info.stdout" and "Kylin"  in  ansible_distribution)
    ignore_errors: true


    
# to set up 'kube_master' nodes
- hosts: kube_master
  any_errors_fatal: true
  roles:
  - ruijie/cluster/keepalived  
  - kube-master
  #- kube-node
  #
  #tasks:
  #- name: Making master nodes SchedulingDisabled
  #  shell: "kubectl cordon {{ inventory_hostname }} "
  #  delegate_to: "{{ groups.deploy[0] }}"
  #  when: DEPLOY_MODE != "allinone"
  #  ignore_errors: true

  #- name: Setting master role name
  #  shell: "kubectl label node {{ inventory_hostname }} kubernetes.io/role=master --overwrite"
  #  ignore_errors: true
  #  delegate_to: "{{ groups.deploy[0] }}"

# to install flannel
- hosts: 
  - kube_master
  - kube_node
  any_errors_fatal: true
  roles:
  - ruijie/cluster/flannel
# to set up 'kube_node' nodes
- hosts: kube_node
  any_errors_fatal: true
  roles:
  - kube-node

- hosts: 
  - kube_master
  - kube_node
  any_errors_fatal: true
  roles:
  - kube-process
# to install network plugin, only one can be choosen
#- hosts:
#  - kube_master
#  - kube_node
#  any_errors_fatal: true
#  roles:
#  - ruijie/cluster/flannel

# to install clust-addons
#- hosts:
#  - kube_node
#  any_errors_fatal: true
#  roles:
#  - ruijie/cluster/kube-dns
#  - ruijie/cluster/ingress

# to install ingress

- hosts: kube_node
  tasks:
  - name: 重启coreDns,触发CoreDns漂移
    shell: "kubectl delete pod -l k8s-app=kube-dns -n kube-system"
    connection: local
    run_once: true
    tags: upgrade_k8s
  
- hosts: kube_node
  any_errors_fatal: true
  roles:
  - ruijie/cluster/ingress



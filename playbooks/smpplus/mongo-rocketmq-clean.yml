- hosts: all
  any_errors_fatal: true

- hosts:
    - localhost
  gather_facts: false

  tasks:
    - name: 获取所有已经创建的POD信息
      tags: always
      command: "kubectl get pod -n {{ APP_NAMESPACE }}"
      register: pod_info

    - name: delete mongo
      tags:
        - mongodb
      command: "kubectl delete -f {{ yaml_dir }}/mongo/"
      when: '"mongo" in pod_info.stdout'

    - name: delete rocketmq
      tags:
        - rocketmq
      command: "kubectl delete -f {{ yaml_dir }}/rocketmq/"
      when: '"rocketmq" in pod_info.stdout'


    - name: 等待mongodb结束运行
      tags:
        - mongodb
      shell: "kubectl get pod -n {{ APP_NAMESPACE }}"
      register: pod_info
      until: '"mongo" not in pod_info.stdout'
      retries: 30
      delay: 3
      ignore_errors: true

    - name: 等待rocketmq结束运行
      tags:
        - rocketmq
      shell: "kubectl get pod -n {{ APP_NAMESPACE }}"
      register: pod_info
      until: '"rocketmq" not in pod_info.stdout'
      retries: 30
      delay: 3
      ignore_errors: true